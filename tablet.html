<!DOCTYPE html><html lang="en"><head>
<meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover">
<title>BurkeCSF</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:opsz,wght@9..40,300;9..40,400;9..40,500;9..40,600&family=JetBrains+Mono:wght@300;400;500;700&display=swap" rel="stylesheet">
<style>
:root{--a:#00ffcc;--ag:rgba(0,255,204,.25);--as:rgba(0,255,204,.1);--c:#0a0a0c;--b:rgba(255,255,255,.12);--t1:#fff;--t2:rgba(255,255,255,.7);--t3:rgba(255,255,255,.4);--e:#ff453a;--f:'DM Sans',-apple-system,system-ui,sans-serif;--m:'JetBrains Mono','SF Mono',monospace;--ez:cubic-bezier(.4,0,.2,1)}
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
body{background:var(--c);color:var(--t1);font-family:var(--f);-webkit-font-smoothing:antialiased;height:100vh;height:100dvh;overflow:hidden;display:flex;flex-direction:column;padding:env(safe-area-inset-top) 0 env(safe-area-inset-bottom)}
.hdr{padding:14px 20px 6px;text-align:center;flex-shrink:0}.brand{font-size:1rem;font-weight:300;color:var(--t2)}
.mode{display:none;flex-direction:column;flex:1;overflow:hidden}.mode.active{display:flex}
.sbar{padding:8px 20px;text-align:center;flex-shrink:0}
.stt{font-family:var(--m);font-size:.65rem;letter-spacing:1.5px;color:var(--t2)}
.sd{display:inline-block;width:8px;height:8px;border-radius:50%;margin-right:6px;vertical-align:middle}
.sd-ok{background:var(--a)}.sd-er{background:var(--e)}.sd-wait{background:rgba(255,255,255,.4);animation:pls 1.5s ease-in-out infinite}
@keyframes pls{0%,100%{opacity:1}50%{opacity:.2}}
#dlog{font-family:var(--m);font-size:.5rem;color:var(--t3);max-height:40px;overflow-y:auto;padding:0 20px;line-height:1.5}
.cal{padding:16px 20px;flex:1;display:flex;flex-direction:column;overflow-y:auto}
.cal-title{font-size:1.2rem;font-weight:300;text-align:center;margin-bottom:2px}
.cal-step-label{font-family:var(--m);font-size:.6rem;letter-spacing:2px;text-transform:uppercase;color:var(--t3);text-align:center;margin-bottom:14px}
.cal-body{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:14px}
.cal-val{font-family:var(--m);font-size:2.4rem;font-weight:500;color:var(--a)}
.cal-hint{font-size:.85rem;color:var(--t2);text-align:center;line-height:1.6}
.cal-msg{font-size:.9rem;color:var(--t2);text-align:center;padding:12px;line-height:1.7}
.cal-slider{width:94%;max-width:320px}
.cal-slider input[type=range]{-webkit-appearance:none;width:100%;height:12px;background:rgba(255,255,255,.15);border-radius:6px;outline:0}
.cal-slider input[type=range]::-webkit-slider-thumb{-webkit-appearance:none;width:40px;height:40px;border-radius:50%;background:var(--a);box-shadow:0 0 20px var(--ag);border:3px solid rgba(0,0,0,.3)}
.cal-slider input[type=range]::-moz-range-thumb{width:40px;height:40px;border-radius:50%;background:var(--a);border:3px solid rgba(0,0,0,.3)}
.cal-sl{display:flex;justify-content:space-between;width:94%;max-width:320px;font-family:var(--m);font-size:.6rem;color:var(--t3);text-transform:uppercase;margin-top:4px}
.cal-nav{display:flex;gap:12px;justify-content:center;padding:16px 0;flex-shrink:0}
.cal-btn{padding:16px 36px;border-radius:100px;font-family:var(--f);font-size:.9rem;cursor:pointer;border:none;transition:all .15s var(--ez)}
.btn-back{background:0;color:var(--t2);border:2px solid var(--b)}.btn-next{background:#fff;color:#0a0a0c}.btn-next:active{background:var(--a)}.btn-start{background:var(--a);color:#0a0a0c;font-weight:500;font-size:1.05rem;padding:18px 52px}
.btn-mirror{padding:16px 28px;border-radius:18px;font-size:1.05rem;font-weight:500;cursor:pointer;border:2px solid var(--b);background:rgba(255,255,255,.03);color:var(--t1)}.btn-mirror:active{border-color:var(--a);background:var(--as);color:var(--a)}
.ph-dist-input{padding:14px 20px;border-radius:14px;border:2px solid var(--b);background:rgba(0,0,0,.3);color:var(--t1);font-family:var(--m);font-size:1.4rem;width:100px;text-align:center;outline:0}.ph-dist-input:focus{border-color:var(--a)}
.ph-dist-select{padding:14px;border-radius:14px;border:2px solid var(--b);background:rgba(0,0,0,.3);color:var(--t1);font-family:var(--m);font-size:1rem;outline:0;cursor:pointer}.ph-dist-select option{background:#222;color:#fff}

/* Tutorial */
.tut{padding:16px;flex:1;display:flex;flex-direction:column;align-items:center;overflow-y:auto}
.tut-title{font-size:1.05rem;font-weight:300;text-align:center;margin-bottom:4px}
.tut-sub{font-size:.8rem;color:var(--t2);text-align:center;margin-bottom:14px}
.tut-grid{display:flex;flex-direction:column;gap:10px;width:min(94vw,360px)}
.tut-row{display:flex;gap:10px}
.tut-btn{flex:1;padding:20px 8px;border-radius:18px;border:2px solid var(--b);background:rgba(255,255,255,.03);text-align:center;display:flex;flex-direction:column;align-items:center;gap:3px;cursor:pointer;-webkit-tap-highlight-color:transparent;touch-action:manipulation;transition:all .12s}
.tut-btn .arrow{font-size:2rem;color:var(--t1)}.tut-btn .lbl{font-family:var(--m);font-size:.6rem;color:var(--t2);letter-spacing:1px}
.tut-btn.dim{opacity:.2;pointer-events:none}
.tut-btn.hl{border-color:var(--e);background:rgba(255,69,58,.12);box-shadow:0 0 20px rgba(255,69,58,.3);animation:hlP 1.2s ease-in-out infinite}.tut-btn.hl .arrow{color:var(--e)}
@keyframes hlP{0%,100%{box-shadow:0 0 14px rgba(255,69,58,.2)}50%{box-shadow:0 0 28px rgba(255,69,58,.5)}}
.tut-no{padding:18px;border-radius:18px;border:2px solid rgba(255,255,255,.08);background:rgba(255,255,255,.02);font-size:1rem;color:var(--t2);text-align:center;cursor:pointer;touch-action:manipulation;transition:all .12s}
.tut-no.dim{opacity:.2;pointer-events:none}
.tut-no.hl{border-color:var(--e);background:rgba(255,69,58,.12);box-shadow:0 0 20px rgba(255,69,58,.3);color:var(--e);animation:hlP 1.2s ease-in-out infinite}
.tut-dots{display:flex;gap:6px;justify-content:center;margin-top:10px}
.tut-dot{width:8px;height:8px;border-radius:50%;background:rgba(255,255,255,.15)}.tut-dot.active{background:var(--a)}
.tut-inst{font-family:var(--m);font-size:.55rem;color:var(--t3);text-align:center;margin-top:8px;letter-spacing:1px}

/* Test */
.test{padding:0 16px;flex:1;display:flex;flex-direction:column}
.test-prog{display:flex;justify-content:center;padding:8px 0;flex-shrink:0}
.ring{position:relative;width:56px;height:56px}.ring svg{width:56px;height:56px;transform:rotate(-90deg)}
.ring .bg{fill:none;stroke:rgba(255,255,255,.1);stroke-width:3}.ring .fg{fill:none;stroke:var(--a);stroke-width:3;stroke-linecap:round;stroke-dasharray:131.9;stroke-dashoffset:131.9;transition:stroke-dashoffset .5s var(--ez)}
.ring .num{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;font-family:var(--m);font-size:.9rem;font-weight:500;color:var(--t1)}
.test-resp{flex:1;display:flex;align-items:center;justify-content:center}
.ori-pad{display:flex;flex-direction:column;gap:12px;width:min(94vw,380px)}
.ori-row{display:flex;gap:12px}
.ori-btn{flex:1;padding:24px 8px;border-radius:20px;border:2px solid var(--b);background:rgba(255,255,255,.03);font-size:2.2rem;color:var(--t1);cursor:pointer;-webkit-tap-highlight-color:transparent;transition:all .1s;touch-action:manipulation;text-align:center;display:flex;flex-direction:column;align-items:center;gap:4px}
.ori-btn:active{transform:scale(.94);background:var(--as);border-color:var(--a);color:var(--a)}
.ori-lbl{font-family:var(--m);font-size:.65rem;letter-spacing:1px;text-transform:uppercase;color:var(--t2)}
.no-btn{padding:20px;border-radius:20px;border:2px solid rgba(255,255,255,.08);background:rgba(255,255,255,.02);font-size:1.1rem;color:var(--t2);cursor:pointer;-webkit-tap-highlight-color:transparent;transition:all .1s;touch-action:manipulation;text-align:center}
.no-btn:active{transform:scale(.97);background:rgba(255,69,58,.08);border-color:rgba(255,69,58,.3);color:var(--e)}

/* Results — higher contrast */
.res{padding:16px 20px;flex:1;display:flex;flex-direction:column;align-items:center;gap:8px;overflow-y:auto}
.res-ey{font-family:var(--m);font-size:.65rem;letter-spacing:3px;text-transform:uppercase;color:rgba(255,255,255,.6)}
.res-sc{font-family:var(--m);font-size:3.5rem;font-weight:700;color:var(--a);line-height:1;text-shadow:0 0 60px var(--ag)}
.res-rk{font-size:1.05rem;font-weight:300;letter-spacing:6px;text-transform:uppercase;color:rgba(255,255,255,.6);margin-top:4px}
.res-dt{font-family:var(--m);font-size:.65rem;color:rgba(255,255,255,.5);margin-top:4px}
.res-plot{width:100%;max-width:380px;border-radius:8px;margin:8px 0}
.res-actions{display:flex;gap:10px;margin-top:8px}
.res-btn{padding:12px 24px;border-radius:100px;border:1.5px solid var(--b);background:0;color:var(--t2);font-size:.8rem;cursor:pointer;display:flex;align-items:center;gap:6px}
.res-btn:active{background:var(--as);border-color:var(--a);color:var(--a)}
.res-btn.primary{background:var(--as);border-color:rgba(0,255,204,.25);color:var(--a)}
.res-copied{font-family:var(--m);font-size:.55rem;color:var(--a);opacity:0;transition:opacity .3s}.res-copied.show{opacity:1}
</style></head><body>
<div class="hdr"><span class="brand">BurkeCSF</span></div>

<div id="m-cal" class="mode active">
<div class="cal">
<div class="cal-step-label" id="csl">Connecting...</div>
<div class="cal-title" id="ctl">Waiting for display</div>
<div class="cal-body" id="cbd"><div class="cal-msg">Connecting to display...</div></div>
<div class="cal-nav" id="cnv"></div>
</div></div>

<div id="m-tut" class="mode">
<div class="tut">
<div class="tut-title" id="ttl">Orientation Demo</div>
<div class="tut-sub" id="tsub">Press the highlighted button</div>
<div class="tut-grid">
<div class="tut-row">
<div class="tut-btn dim" id="tb-upleft" onclick="tutTap('upleft')"><span class="arrow">&#8598;</span><span class="lbl">Left</span></div>
<div class="tut-btn dim" id="tb-up" onclick="tutTap('up')"><span class="arrow">&#8593;</span><span class="lbl">Vertical</span></div>
<div class="tut-btn dim" id="tb-upright" onclick="tutTap('upright')"><span class="arrow">&#8599;</span><span class="lbl">Right</span></div>
</div>
<div class="tut-row">
<div class="tut-btn dim" id="tb-right" onclick="tutTap('right')" style="max-width:45%;margin:0 auto"><span class="arrow">&#8594;</span><span class="lbl">Horiz</span></div>
</div>
<div class="tut-no dim" id="tb-none" onclick="tutTap('none')">No Target Visible</div>
</div>
<div class="tut-dots" id="tdots"></div>
<div class="tut-inst" id="tinst">Look at the display</div>
</div></div>

<div id="m-test" class="mode">
<div class="test">
<div class="test-prog"><div class="ring"><svg viewBox="0 0 48 48"><circle class="bg" cx="24" cy="24" r="21"/><circle class="fg" id="rfg" cx="24" cy="24" r="21"/></svg><div class="num" id="rnum">0</div></div></div>
<div class="test-resp">
<div class="ori-pad">
<div class="ori-row">
<button class="ori-btn" onclick="send('upleft')">&#8598;<span class="ori-lbl">Left</span></button>
<button class="ori-btn" onclick="send('up')">&#8593;<span class="ori-lbl">Vertical</span></button>
<button class="ori-btn" onclick="send('upright')">&#8599;<span class="ori-lbl">Right</span></button>
</div>
<div class="ori-row">
<button class="ori-btn" onclick="send('right')" style="max-width:45%;margin:0 auto">&#8594;<span class="ori-lbl">Horiz</span></button>
</div>
<button class="no-btn" onclick="send('none')">No Target Visible</button>
</div></div>
</div></div>

<div id="m-res" class="mode">
<div class="res">
<div class="res-ey">Area Under Log CSF</div>
<div class="res-sc" id="rsc">--</div>
<div class="res-rk" id="rrk"></div><div class="res-dt" id="rdt"></div>
<img class="res-plot" id="rplot" style="display:none" alt="CSF">
<div class="res-actions">
<button class="res-btn primary" onclick="shareR()">Share</button>
<button class="res-btn" onclick="copyR()">Copy</button>
</div>
<div class="res-copied" id="rcp">Copied</div>
</div></div>

<div class="sbar"><div class="stt" id="stt"><span class="sd sd-wait"></span>Connecting...</div></div>
<div id="dlog"></div>

<script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
<script>if(typeof Peer==='undefined'){var s=document.createElement('script');s.src='https://cdnjs.cloudflare.com/ajax/libs/peerjs/1.5.2/peerjs.min.js';document.head.appendChild(s)}</script>
<script>
function dlog(m){const e=document.getElementById('dlog');if(e){e.textContent+=m+'\n';e.scrollTop=e.scrollHeight}console.log('[T]',m)}
function setSt(cls,txt){document.getElementById('stt').innerHTML='<span class="sd '+cls+'"></span>'+txt}
function setMode(id){document.querySelectorAll('.mode').forEach(m=>m.classList.remove('active'));document.getElementById(id).classList.add('active')}

const P=new URLSearchParams(location.search),targetID=P.get('id');
let conn=null,isConn=false;
if(!targetID){setSt('sd-er','No ID');dlog('No id')}
else{dlog('Target: '+targetID);if(typeof Peer==='undefined')setTimeout(function(){if(typeof Peer!=='undefined')doConnect();else setSt('sd-er','PeerJS failed')},2000);else doConnect()}

function doConnect(){
    setSt('sd-wait','Connecting...');
    var p=new Peer(undefined,{debug:1,config:{iceServers:[{urls:'stun:stun.l.google.com:19302'},{urls:'stun:stun1.l.google.com:19302'}]}});
    var timeout=setTimeout(function(){if(!isConn){setSt('sd-er','Timed out');dlog('Timeout')}},30000);
    p.on('open',function(myId){
        dlog('My ID: '+myId.substring(0,8));
        conn=p.connect(targetID,{reliable:true});
        conn.on('open',function(){clearTimeout(timeout);isConn=true;dlog('CONNECTED');setSt('sd-ok','Linked')});
        conn.on('data',onMsg);
        conn.on('close',function(){isConn=false;setSt('sd-er','Disconnected')});
        conn.on('error',function(e){dlog('Conn err: '+(e.type||e))});
    });
    p.on('error',function(e){clearTimeout(timeout);dlog('Peer err: '+e.type);setSt('sd-er',e.type==='peer-unavailable'?'Display not found':'Error: '+e.type)});
    p.on('disconnected',function(){if(!p.destroyed)p.reconnect()});
}

function tx(m){if(conn&&isConn)conn.send(m);else dlog('tx fail')}

function onMsg(d){
    if(d.type==='calStep')renderCalStep(d);
    if(d.type==='mirrorSet')dlog('Mirror: '+d.value);
    if(d.type==='tutStep')renderTutStep(d);
    if(d.type==='testStart'){dlog('Test');setMode('m-test')}
    if(d.type==='progress')updateRing(d.trial,d.maxTrials);
    if(d.type==='results')showResults(d);
}

// ═══ Calibration ═══
var distTimer=null;
function renderCalStep(d){
    var bd=document.getElementById('cbd'),tl=document.getElementById('ctl'),sl=document.getElementById('csl'),nv=document.getElementById('cnv');
    setMode('m-cal');
    if(d.step===0){
        sl.textContent='STEP 1 \u00B7 SCALE';tl.textContent='Card Size';
        bd.innerHTML='<div class="cal-msg">Match the rectangle on display to a credit card width.</div><div class="cal-slider"><input type="range" id="csl2" min="150" max="750" step="0.1" value="'+(d.cardPx||300)+'" oninput="onCard(this.value)"></div><div class="cal-sl"><span>SMALLER</span><span>LARGER</span></div>';
        nv.innerHTML='<button class="cal-btn btn-next" onclick="nav(\'next\')">Next</button>';
    }else if(d.step===1){
        sl.textContent='STEP 2 \u00B7 SETUP';tl.textContent='Mirror Setup';
        bd.innerHTML='<div class="cal-msg">Will the patient view through a mirror?</div><div style="display:flex;gap:14px;justify-content:center;margin-top:6px"><button class="btn-mirror" onclick="sendMirror(false)">Direct View</button><button class="btn-mirror" onclick="sendMirror(true)">Mirror View</button></div>';
        nv.innerHTML='<button class="cal-btn btn-back" onclick="nav(\'back\')">Back</button>';
    }else if(d.step===2){
        sl.textContent='STEP 3 \u00B7 LUMINANCE';tl.textContent='Brightness';
        bd.innerHTML='<div class="cal-val" id="gval">'+(d.gamma||128)+'</div><div class="cal-slider"><input type="range" id="gsl" min="60" max="220" value="'+(d.gamma||128)+'" oninput="onGamma(this.value)"></div><div class="cal-sl"><span>DARKER</span><span>BRIGHTER</span></div><div class="cal-hint">Adjust until circle disappears into checkerboard</div>';
        nv.innerHTML='<button class="cal-btn btn-back" onclick="nav(\'back\')">Back</button><button class="cal-btn btn-next" onclick="nav(\'next\')">Next</button>';
    }else if(d.step===3){
        sl.textContent='STEP 4 \u00B7 DISTANCE';tl.textContent='Viewing Distance';
        bd.innerHTML='<div class="cal-hint" style="margin-bottom:10px">Enter distance from eyes to screen</div><div style="display:flex;gap:10px;align-items:center;justify-content:center"><input type="number" class="ph-dist-input" id="pdv" placeholder="5" min="0.1" step="0.1" inputmode="decimal" oninput="onDistInput()"><select class="ph-dist-select" id="pdu" onchange="onDistInput()"><option value="ft">feet</option><option value="m">meters</option><option value="cm">cm</option><option value="in">inches</option></select></div>';
        nv.innerHTML='<button class="cal-btn btn-back" onclick="nav(\'back\')">Back</button><button class="cal-btn btn-next" onclick="nav(\'next\')">Review</button>';
    }else if(d.step===4){
        sl.textContent='STEP 5 \u00B7 CONFIRM';tl.textContent='Review';
        bd.innerHTML='<div class="cal-msg" style="font-size:1rem">Review on display. Press Start.</div>';
        nv.innerHTML='<button class="cal-btn btn-back" onclick="nav(\'back\')">Back</button><button class="cal-btn btn-start" onclick="nav(\'start\')">Start Test</button>';
    }
}

function onGamma(v){document.getElementById('gval').textContent=v;tx({type:'gamma',value:parseInt(v)})}
function onCard(v){tx({type:'cardSize',value:parseFloat(v)})}
function nav(to){tx({type:'nav',to:to})}
function sendMirror(v){tx({type:'mirror',value:v})}
function onDistInput(){
    // Auto-sync to display on every keystroke with small debounce
    clearTimeout(distTimer);
    distTimer=setTimeout(function(){
        var v=document.getElementById('pdv').value,u=document.getElementById('pdu').value;
        if(v&&!isNaN(parseFloat(v))&&parseFloat(v)>0)tx({type:'distance',value:parseFloat(v),unit:u});
    },300);
}

// ═══ Tutorial ═══
var curTutKey=null;
function renderTutStep(d){
    setMode('m-tut');curTutKey=d.key;
    document.getElementById('ttl').textContent='Demo '+( d.stepIdx+1)+' of '+d.total;
    document.getElementById('tsub').textContent=d.stepIdx<d.total-1?'Press '+d.arrow+' '+d.name:'Press No Target';
    ['tb-upleft','tb-up','tb-upright','tb-right','tb-none'].forEach(function(id){var el=document.getElementById(id);el.className=el.className.replace(/ hl/g,'');if(!el.className.match(/dim/))el.className+=' dim'});
    var map={upleft:'tb-upleft',up:'tb-up',upright:'tb-upright',right:'tb-right',none:'tb-none'};
    var t=document.getElementById(map[d.key]);
    if(t){t.className=t.className.replace(/ dim/g,'');t.className+=' hl'}
    var dots=document.getElementById('tdots');dots.innerHTML='';
    for(var i=0;i<d.total;i++){var dot=document.createElement('div');dot.className='tut-dot'+(i===d.stepIdx?' active':'');dots.appendChild(dot)}
    document.getElementById('tinst').textContent=d.stepIdx<d.total-1?'Press the highlighted button':'Press No Target to start testing';
}
function tutTap(key){if(key===curTutKey)tx({type:'input',value:key})}

// ═══ Test ═══
function send(v){if(!isConn)return;tx({type:'input',value:v});if(navigator.vibrate)navigator.vibrate(20)}
function updateRing(t,mx){document.getElementById('rfg').style.strokeDashoffset=2*Math.PI*21*(1-t/mx);document.getElementById('rnum').textContent=t}

// ═══ Results ═══
var resultData=null;
function showResults(d){
    resultData={score:d.score||'--',rank:d.rank||'',detail:d.detail||'',date:new Date().toLocaleDateString('en-US',{year:'numeric',month:'long',day:'numeric'})};
    setMode('m-res');
    document.getElementById('rsc').textContent=resultData.score;
    document.getElementById('rrk').textContent=resultData.rank;
    document.getElementById('rdt').textContent=resultData.detail;
    if(d.plotDataUrl){document.getElementById('rplot').src=d.plotDataUrl;document.getElementById('rplot').style.display='block'}
}
function getRText(){if(!resultData)return'';return'BurkeCSF\nAULCSF: '+resultData.score+'\nRating: '+resultData.rank+'\n'+resultData.detail+'\n'+resultData.date}
function shareR(){if(!resultData)return;if(navigator.share)navigator.share({title:'BurkeCSF',text:getRText()}).catch(function(){});else copyR()}
function copyR(){if(!resultData)return;navigator.clipboard.writeText(getRText()).then(function(){var e=document.getElementById('rcp');e.classList.add('show');setTimeout(function(){e.classList.remove('show')},2000)}).catch(function(){})}
</script></body></html>
