<!DOCTYPE html><html lang="en"><head>
<meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover">
<title>Burke Vision Lab</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:opsz,wght@9..40,300;9..40,400;9..40,500;9..40,600&family=JetBrains+Mono:wght@300;400;500;700&display=swap" rel="stylesheet">
<style>
:root{--a:#00ffcc;--ag:rgba(0,255,204,.25);--as:rgba(0,255,204,.1);--c:#0a0a0c;--b:rgba(255,255,255,.12);--t1:#fff;--t2:rgba(255,255,255,.7);--t3:rgba(255,255,255,.4);--e:#ff453a;--f:'DM Sans',-apple-system,system-ui,sans-serif;--m:'JetBrains Mono','SF Mono',monospace;--ez:cubic-bezier(.4,0,.2,1)}
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
html{font-size:200%}
body{background:var(--c);color:var(--t1);font-family:var(--f);-webkit-font-smoothing:antialiased;height:100vh;height:100dvh;overflow:hidden;display:flex;flex-direction:column;padding:env(safe-area-inset-top) 0 env(safe-area-inset-bottom)}
.hdr{padding:14px 20px 6px;text-align:center;flex-shrink:0}.brand{font-size:1rem;font-weight:300;color:var(--t2)}
.mode{display:none;flex-direction:column;flex:1;overflow:hidden}.mode.active{display:flex}
.sbar{padding:8px 20px;text-align:center;flex-shrink:0}
.stt{font-family:var(--m);font-size:.65rem;letter-spacing:1.5px;color:var(--t2)}
.sd{display:inline-block;width:8px;height:8px;border-radius:50%;margin-right:6px;vertical-align:middle}
.sd-ok{background:var(--a)}.sd-er{background:var(--e)}.sd-wait{background:rgba(255,255,255,.4);animation:pls 1.5s ease-in-out infinite}
@keyframes pls{0%,100%{opacity:1}50%{opacity:.2}}
#dlog{font-family:var(--m);font-size:.45rem;color:var(--t3);max-height:36px;overflow-y:auto;padding:0 20px;line-height:1.4}
.cal{padding:14px 20px;flex:1;display:flex;flex-direction:column;overflow-y:auto}
.cal-title{font-size:1.15rem;font-weight:300;text-align:center;margin-bottom:2px}
.cal-step-label{font-family:var(--m);font-size:.58rem;letter-spacing:2px;text-transform:uppercase;color:var(--t3);text-align:center;margin-bottom:12px}
.cal-body{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:12px}
.cal-val{font-family:var(--m);font-size:2.4rem;font-weight:500;color:var(--a)}
.cal-hint{font-size:.82rem;color:var(--t2);text-align:center;line-height:1.6}
.cal-msg{font-size:.88rem;color:var(--t2);text-align:center;padding:12px;line-height:1.7}
.cal-slider{width:94%;max-width:320px}
.cal-slider input[type=range]{-webkit-appearance:none;width:100%;height:12px;background:rgba(255,255,255,.15);border-radius:6px;outline:0}
.cal-slider input[type=range]::-webkit-slider-thumb{-webkit-appearance:none;width:40px;height:40px;border-radius:50%;background:var(--a);box-shadow:0 0 20px var(--ag);border:3px solid rgba(0,0,0,.3)}
.cal-slider input[type=range]::-moz-range-thumb{width:40px;height:40px;border-radius:50%;background:var(--a);border:3px solid rgba(0,0,0,.3)}
.cal-sl{display:flex;justify-content:space-between;width:94%;max-width:320px;font-family:var(--m);font-size:.58rem;color:var(--t3);text-transform:uppercase;margin-top:3px}
.cal-nav{display:flex;gap:12px;justify-content:center;padding:14px 0;flex-shrink:0}
.cal-btn{padding:15px 34px;border-radius:100px;font-family:var(--f);font-size:.88rem;cursor:pointer;border:none;transition:all .15s var(--ez)}
.btn-back{background:0;color:var(--t2);border:2px solid var(--b)}.btn-next{background:#fff;color:#0a0a0c}.btn-next:active{background:var(--a)}.btn-start{background:var(--a);color:#0a0a0c;font-weight:500;font-size:1.02rem;padding:18px 50px}
.btn-mirror{padding:15px 28px;border-radius:18px;font-size:1.02rem;font-weight:500;cursor:pointer;border:2px solid var(--b);background:rgba(255,255,255,.03);color:var(--t1)}.btn-mirror:active{border-color:var(--a);background:var(--as);color:var(--a)}
.ph-dist-input{padding:14px 20px;border-radius:14px;border:2px solid var(--b);background:rgba(0,0,0,.3);color:var(--t1);font-family:var(--m);font-size:1.4rem;width:100px;text-align:center;outline:0}.ph-dist-input:focus{border-color:var(--a)}
.ph-dist-select{padding:14px;border-radius:14px;border:2px solid var(--b);background:rgba(0,0,0,.3);color:var(--t1);font-family:var(--m);font-size:1rem;outline:0}.ph-dist-select option{background:#222;color:#fff}
.tut{padding:16px;flex:1;display:flex;flex-direction:column;align-items:center;overflow-y:auto}
.tut-title{font-size:1.02rem;font-weight:300;text-align:center;margin-bottom:4px}
.tut-sub{font-size:.78rem;color:var(--t2);text-align:center;margin-bottom:12px}
.tut-grid{display:flex;flex-direction:column;gap:10px;width:min(94vw,360px)}
.tut-row{display:flex;gap:10px}
.tut-btn{flex:1;padding:20px 8px;border-radius:18px;border:2px solid var(--b);background:rgba(255,255,255,.03);text-align:center;display:flex;flex-direction:column;align-items:center;gap:3px;cursor:pointer;-webkit-tap-highlight-color:transparent;touch-action:manipulation;transition:all .12s}
.tut-btn .arrow{font-size:2rem;color:var(--t1)}.tut-btn .lbl{font-family:var(--m);font-size:.58rem;color:var(--t2);letter-spacing:1px}
.tut-btn.dim{opacity:.2;pointer-events:none}
.tut-btn.hl{border-color:var(--e);background:rgba(255,69,58,.12);box-shadow:0 0 20px rgba(255,69,58,.3);animation:hlP 1.2s ease-in-out infinite}.tut-btn.hl .arrow{color:var(--e)}
@keyframes hlP{0%,100%{box-shadow:0 0 14px rgba(255,69,58,.2)}50%{box-shadow:0 0 28px rgba(255,69,58,.5)}}
.tut-no{padding:18px;border-radius:18px;border:2px solid rgba(255,255,255,.08);background:rgba(255,255,255,.02);font-size:1rem;color:var(--t2);text-align:center;cursor:pointer;touch-action:manipulation;transition:all .12s}
.tut-no.dim{opacity:.2;pointer-events:none}
.tut-no.hl{border-color:var(--e);background:rgba(255,69,58,.12);box-shadow:0 0 20px rgba(255,69,58,.3);color:var(--e);animation:hlP 1.2s ease-in-out infinite}
.tut-dots{display:flex;gap:6px;justify-content:center;margin-top:10px}
.tut-dot{width:8px;height:8px;border-radius:50%;background:rgba(255,255,255,.15)}.tut-dot.active{background:var(--a)}
.tut-inst{font-family:var(--m);font-size:.52rem;color:var(--t3);text-align:center;margin-top:6px;letter-spacing:1px}
.test{padding:0 16px;flex:1;display:flex;flex-direction:column}
.test-prog{display:flex;justify-content:center;padding:8px 0;flex-shrink:0}
.ring{position:relative;width:56px;height:56px}.ring svg{width:56px;height:56px;transform:rotate(-90deg)}
.ring .bg{fill:none;stroke:rgba(255,255,255,.1);stroke-width:3}.ring .fg{fill:none;stroke:var(--a);stroke-width:3;stroke-linecap:round;stroke-dasharray:131.9;stroke-dashoffset:131.9;transition:stroke-dashoffset .5s var(--ez)}
.ring .num{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;font-family:var(--m);font-size:.9rem;font-weight:500;color:var(--t1)}
.test-resp{flex:1;display:flex;align-items:center;justify-content:center}
.ori-pad{display:flex;flex-direction:column;gap:12px;width:min(94vw,380px)}
.ori-row{display:flex;gap:12px}
.ori-btn{flex:1;padding:24px 8px;border-radius:20px;border:2px solid var(--b);background:rgba(255,255,255,.03);font-size:2.2rem;color:var(--t1);cursor:pointer;-webkit-tap-highlight-color:transparent;transition:all .1s;touch-action:manipulation;text-align:center;display:flex;flex-direction:column;align-items:center;gap:4px}
.ori-btn:active{transform:scale(.94);background:var(--as);border-color:var(--a);color:var(--a)}
.ori-lbl{font-family:var(--m);font-size:.65rem;letter-spacing:1px;text-transform:uppercase;color:var(--t2)}
.no-btn{padding:20px;border-radius:20px;border:2px solid rgba(255,255,255,.08);background:rgba(255,255,255,.02);font-size:1.1rem;color:var(--t2);cursor:pointer;-webkit-tap-highlight-color:transparent;transition:all .1s;touch-action:manipulation;text-align:center}
.no-btn:active{transform:scale(.97);background:rgba(255,69,58,.08);border-color:rgba(255,69,58,.3);color:var(--e)}
.res{padding:16px 20px;flex:1;display:flex;flex-direction:column;align-items:center;gap:6px;overflow-y:auto}
.res-ey{font-family:var(--m);font-size:.6rem;letter-spacing:3px;text-transform:uppercase;color:rgba(255,255,255,.5)}
.res-sc{font-family:var(--m);font-size:3.2rem;font-weight:700;color:var(--a);line-height:1;text-shadow:0 0 60px var(--ag)}
.res-rk{font-size:.95rem;font-weight:300;letter-spacing:5px;text-transform:uppercase;color:rgba(255,255,255,.55);margin-bottom:6px}
.res-stats{display:flex;gap:6px;width:100%;margin:6px 0}
.res-stat{flex:1;padding:10px 6px;border-radius:12px;border:1px solid var(--b);background:rgba(255,255,255,.02);text-align:center}
.rs-val{font-family:var(--m);font-size:1.1rem;font-weight:600;color:var(--a)}
.rs-lbl{font-size:.55rem;color:var(--t3);margin-top:2px;letter-spacing:.5px}
.res-section-title{font-family:var(--m);font-size:.7rem;letter-spacing:2px;text-transform:uppercase;color:var(--t2);margin:8px 0 4px;width:100%;text-align:center}
.res-lm-list{width:100%;display:flex;flex-direction:column;gap:4px}
.res-lm{display:flex;align-items:center;gap:8px;padding:8px 10px;border-radius:10px;border:1px solid var(--b);background:rgba(255,255,255,.01)}
.lm-icon{font-size:1.1rem;width:24px;text-align:center;flex-shrink:0}
.lm-pass .lm-icon{color:#34d399}.lm-fail .lm-icon{color:var(--e)}
.lm-info{flex:1;min-width:0}
.lm-name{font-size:.72rem;font-weight:500;color:var(--t1);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.lm-ctx{font-size:.52rem;color:var(--t3);margin-top:1px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.lm-score{text-align:right;flex-shrink:0}
.lm-yours{font-family:var(--m);font-size:.85rem;font-weight:600;color:var(--t1)}
.lm-need{font-size:.48rem;color:var(--t3)}
.lm-pass .lm-need{color:rgba(52,211,153,.6)}.lm-fail .lm-need{color:rgba(255,69,58,.6)}
.res-plot{width:100%;max-width:380px;border-radius:8px;margin:8px 0}
.res-actions{display:flex;gap:10px;margin-top:6px}
.res-btn{padding:12px 24px;border-radius:100px;border:1.5px solid var(--b);background:0;color:var(--t2);font-size:.78rem;cursor:pointer;display:flex;align-items:center;gap:6px;font-family:var(--f)}
.res-btn:active{background:var(--as);border-color:var(--a);color:var(--a)}
.res-btn.primary{background:var(--as);border-color:rgba(0,255,204,.25);color:var(--a)}
.res-copied{font-family:var(--m);font-size:.5rem;color:var(--a);opacity:0;transition:opacity .3s}.res-copied.show{opacity:1}
</style></head><body>
<div class="hdr"><span class="brand">Burke Vision Lab</span></div>

<div id="m-cal" class="mode active">
<div class="cal">
<div class="cal-step-label" id="csl">Connecting...</div>
<div class="cal-title" id="ctl">Waiting for display</div>
<div class="cal-body" id="cbd"><div class="cal-msg">Connecting to display...</div></div>
<div class="cal-nav" id="cnv"></div>
</div></div>

<div id="m-tut" class="mode">
<div class="tut">
<div class="tut-title" id="ttl">Orientation Demo</div>
<div class="tut-sub" id="tsub">Press the highlighted button</div>
<div class="tut-grid">
<div class="tut-row">
<div class="tut-btn dim" id="tb-upleft" onclick="tutTap('upleft')"><span class="arrow">&#8598;</span><span class="lbl">Left</span></div>
<div class="tut-btn dim" id="tb-up" onclick="tutTap('up')"><span class="arrow">&#8593;</span><span class="lbl">Vertical</span></div>
<div class="tut-btn dim" id="tb-upright" onclick="tutTap('upright')"><span class="arrow">&#8599;</span><span class="lbl">Right</span></div>
</div>
<div class="tut-row">
<div class="tut-btn dim" id="tb-right" onclick="tutTap('right')" style="max-width:45%;margin:0 auto"><span class="arrow">&#8594;</span><span class="lbl">Horiz</span></div>
</div>
</div>
<div class="tut-dots" id="tdots"></div>
<div class="tut-inst" id="tinst">Look at the display</div>
</div></div>

<div id="m-test" class="mode">
<div class="test">
<div class="test-prog"><div class="ring"><svg viewBox="0 0 48 48"><circle class="bg" cx="24" cy="24" r="21"/><circle class="fg" id="rfg" cx="24" cy="24" r="21"/></svg><div class="num" id="rnum">0</div></div></div>
<div class="test-resp">
<div class="ori-pad">
<div class="ori-row">
<button class="ori-btn" onclick="send('upleft')">&#8598;<span class="ori-lbl">Left</span></button>
<button class="ori-btn" onclick="send('up')">&#8593;<span class="ori-lbl">Vertical</span></button>
<button class="ori-btn" onclick="send('upright')">&#8599;<span class="ori-lbl">Right</span></button>
</div>
<div class="ori-row">
<button class="ori-btn" onclick="send('right')" style="max-width:45%;margin:0 auto">&#8594;<span class="ori-lbl">Horiz</span></button>
</div>
<button class="no-btn" onclick="send('none')">No Target Visible</button>
</div></div>
</div></div>

<div id="m-res" class="mode">
<div class="res" id="result-content">
</div></div>

<div class="sbar"><div class="stt" id="stt"><span class="sd sd-wait"></span>Connecting...</div></div>
<div id="dlog"></div>

<script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
<script>
// Safari fallback CDN
if(typeof Peer==='undefined'){var s=document.createElement('script');s.src='https://cdnjs.cloudflare.com/ajax/libs/peerjs/1.5.2/peerjs.min.js';document.head.appendChild(s)}
</script>
<script>
var ICE=[{urls:'stun:stun.l.google.com:19302'},{urls:'stun:stun1.l.google.com:19302'},{urls:'stun:stun2.l.google.com:19302'},{urls:'stun:stun3.l.google.com:19302'},{urls:'stun:stun4.l.google.com:19302'}];

function dlog(m){var e=document.getElementById('dlog');if(e){e.textContent+=m+'\n';e.scrollTop=e.scrollHeight}console.log('[T]',m)}
function setSt(cls,txt){document.getElementById('stt').innerHTML='<span class="sd '+cls+'"></span>'+txt}
function setMode(id){document.querySelectorAll('.mode').forEach(function(m){m.classList.remove('active')});document.getElementById(id).classList.add('active')}

var P=new URLSearchParams(location.search),targetID=P.get('id');
var conn=null,isConn=false,peer=null;

if(!targetID){setSt('sd-er','No display ID');dlog('No id in URL')}
else{dlog('Target: '+targetID);waitForPeer()}

function waitForPeer(){
    if(typeof Peer!=='undefined'){doConnect();return}
    var tries=0;
    var iv=setInterval(function(){
        tries++;
        if(typeof Peer!=='undefined'){clearInterval(iv);doConnect()}
        else if(tries>30){clearInterval(iv);setSt('sd-er','PeerJS failed to load');dlog('PeerJS never loaded')}
    },200);
}

function doConnect(){
    setSt('sd-wait','Connecting...');
    var myId='csf'+Date.now().toString(36)+Math.random().toString(36).slice(2,6);
    peer=new Peer(myId,{debug:0,config:{iceServers:ICE}});
    var timeout=setTimeout(function(){
        if(!isConn){setSt('sd-er','Timed out');dlog('30s timeout');tryReconnect()}
    },30000);

    peer.on('open',function(id){
        dlog('My ID: '+id.substring(0,10));
        conn=peer.connect(targetID,{reliable:true,serialization:'json'});
        conn.on('open',function(){
            clearTimeout(timeout);isConn=true;
            dlog('CONNECTED');setSt('sd-ok','Linked');
        });
        conn.on('data',onMsg);
        conn.on('close',function(){isConn=false;setSt('sd-er','Disconnected');tryReconnect()});
        conn.on('error',function(e){dlog('Conn err: '+(e.type||e))});
    });
    peer.on('error',function(e){
        clearTimeout(timeout);
        dlog('Peer err: '+e.type);
        if(e.type==='peer-unavailable'){setSt('sd-er','Display not found - check QR code');dlog('Target peer not found')}
        else{setSt('sd-er','Error: '+e.type)}
    });
    peer.on('disconnected',function(){if(!peer.destroyed)peer.reconnect()});
}

var reconnAttempts=0;
function tryReconnect(){
    if(reconnAttempts>=3){setSt('sd-er','Could not connect. Reload page.');return}
    reconnAttempts++;
    dlog('Retry #'+reconnAttempts);
    setSt('sd-wait','Retrying...');
    if(peer&&!peer.destroyed)peer.destroy();
    setTimeout(doConnect,2000);
}

function tx(m){if(conn&&isConn)conn.send(m);else dlog('tx fail: not connected')}

function onMsg(d){
    if(d.type==='calStep')renderCalStep(d);
    if(d.type==='mirrorSet')dlog('Mirror: '+d.value);
    if(d.type==='tutStep')renderTutStep(d);
    if(d.type==='testStart'){dlog('Test started');setMode('m-test')}
    if(d.type==='progress')updateRing(d.trial,d.maxTrials);
    if(d.type==='results'){dlog('Results received');showResults(d)}
    if(d.type==='plotImage'){
        var img=document.querySelector('.res-plot');
        if(img){img.src=d.url;img.style.display='block'}
        else{
            var c=document.getElementById('result-content');
            if(c){var i=document.createElement('img');i.className='res-plot';i.src=d.url;i.alt='CSF Plot';c.insertBefore(i,c.querySelector('.res-actions'))}
        }
    }
}

// ═══ Calibration ═══
var distTimer=null;

function renderCalStep(d){
    var bd=document.getElementById('cbd'),tl=document.getElementById('ctl'),sl=document.getElementById('csl'),nv=document.getElementById('cnv');
    setMode('m-cal');
    if(d.step===0){
        sl.textContent='STEP 1 / SCALE';tl.textContent='Card Size';
        bd.innerHTML='<div class="cal-msg">Match the rectangle on display to a credit card width.</div>'
            +'<div class="cal-slider"><input type="range" id="csl2" min="150" max="750" step="0.1" value="'+(d.cardPx||300)+'" oninput="onCard(this.value)"></div>'
            +'<div class="cal-sl"><span>SMALLER</span><span>LARGER</span></div>';
        nv.innerHTML='<button class="cal-btn btn-next" onclick="nav(\'next\')">Next</button>';
    }else if(d.step===1){
        sl.textContent='STEP 2 / SETUP';tl.textContent='Mirror Setup';
        bd.innerHTML='<div class="cal-msg">Will the patient view through a mirror?</div>'
            +'<div style="display:flex;gap:14px;justify-content:center;margin-top:6px">'
            +'<button class="btn-mirror" onclick="sendMirror(false)">Direct View</button>'
            +'<button class="btn-mirror" onclick="sendMirror(true)">Mirror View</button></div>';
        nv.innerHTML='<button class="cal-btn btn-back" onclick="nav(\'back\')">Back</button>';
    }else if(d.step===2){
        sl.textContent='STEP 3 / LUMINANCE';tl.textContent='Brightness';
        bd.innerHTML='<div class="cal-val" id="gval">'+(d.gamma||128)+'</div>'
            +'<div class="cal-slider"><input type="range" id="gsl" min="60" max="220" value="'+(d.gamma||128)+'" oninput="onGamma(this.value)"></div>'
            +'<div class="cal-sl"><span>DARKER</span><span>BRIGHTER</span></div>'
            +'<div class="cal-hint">Adjust until circle disappears into checkerboard</div>';
        nv.innerHTML='<button class="cal-btn btn-back" onclick="nav(\'back\')">Back</button><button class="cal-btn btn-next" onclick="nav(\'next\')">Next</button>';
    }else if(d.step===3){
        sl.textContent='STEP 4 / DISTANCE';tl.textContent='Viewing Distance';
        bd.innerHTML='<div class="cal-hint" style="margin-bottom:10px">Enter distance from eyes to screen</div>'
            +'<div style="display:flex;gap:10px;align-items:center;justify-content:center">'
            +'<input type="number" class="ph-dist-input" id="pdv" placeholder="5" min="0.1" step="0.1" inputmode="decimal" oninput="onDistInput()" onchange="onDistInput()">'
            +'<select class="ph-dist-select" id="pdu" onchange="onDistInput()"><option value="ft">feet</option><option value="m">meters</option><option value="cm">cm</option><option value="in">inches</option></select></div>';
        nv.innerHTML='<button class="cal-btn btn-back" onclick="nav(\'back\')">Back</button><button class="cal-btn btn-next" onclick="nav(\'next\')">Review</button>';
    }else if(d.step===4){
        sl.textContent='STEP 5 / CONFIRM';tl.textContent='Review';
        bd.innerHTML='<div class="cal-msg" style="font-size:1rem">Review settings on display, then press Start.</div>';
        nv.innerHTML='<button class="cal-btn btn-back" onclick="nav(\'back\')">Back</button><button class="cal-btn btn-start" onclick="nav(\'start\')">Start Test</button>';
    }
}

function onGamma(v){document.getElementById('gval').textContent=v;tx({type:'gamma',value:parseInt(v)})}
function onCard(v){tx({type:'cardSize',value:parseFloat(v)})}
function nav(to){tx({type:'nav',to:to})}
function sendMirror(v){tx({type:'mirror',value:v})}

function onDistInput(){
    clearTimeout(distTimer);
    distTimer=setTimeout(function(){
        var v=document.getElementById('pdv').value;
        var u=document.getElementById('pdu').value;
        if(v&&!isNaN(parseFloat(v))&&parseFloat(v)>0){
            tx({type:'distance',value:parseFloat(v),unit:u});
        }
    },300);
}

// ═══ Tutorial ═══
var curTutKey=null;
function renderTutStep(d){
    setMode('m-tut');curTutKey=d.key;
    document.getElementById('ttl').textContent='Demo '+(d.stepIdx+1)+' of '+d.total;
    document.getElementById('tsub').textContent=d.stepIdx<d.total-1?'Press '+d.arrow+' '+d.name:'Complete this step to begin';

    var allIds=['tb-upleft','tb-up','tb-upright','tb-right'];
    allIds.forEach(function(id){
        var el=document.getElementById(id);
        el.classList.remove('hl');
        el.classList.add('dim');
    });
    var map={upleft:'tb-upleft',up:'tb-up',upright:'tb-upright',right:'tb-right'};
    var t=document.getElementById(map[d.key]);
    if(t){t.classList.remove('dim');t.classList.add('hl')}

    var dots=document.getElementById('tdots');dots.innerHTML='';
    for(var i=0;i<d.total;i++){
        var dot=document.createElement('div');
        dot.className='tut-dot'+(i===d.stepIdx?' active':'');
        dots.appendChild(dot);
    }
     document.getElementById('tinst').textContent=d.stepIdx<d.total-1?'Press the highlighted button':'Tap the highlighted button to start testing';
}

function tutTap(key){if(key===curTutKey)tx({type:'input',value:key})}

// ═══ Test ═══
function send(v){if(!isConn)return;tx({type:'input',value:v});if(navigator.vibrate)navigator.vibrate(20)}
function updateRing(t,mx){
    var circ=2*Math.PI*21;
    document.getElementById('rfg').style.strokeDashoffset=circ*(1-t/mx);
    document.getElementById('rnum').textContent=t;
}

// ═══ Results ═══
var resultData=null;
function showResults(d){
    resultData=d;
    setMode('m-res');
    var c=document.getElementById('result-content');
    c.innerHTML='';

    // Hero score
    c.innerHTML+='<div class="res-ey">Area Under Log CSF</div>';
    c.innerHTML+='<div class="res-sc">'+(d.score||'--')+'</div>';
    c.innerHTML+='<div class="res-rk">'+(d.rank||'')+'</div>';

    // Snellen + Peak
    c.innerHTML+='<div class="res-stats">'
        +'<div class="res-stat"><div class="rs-val">'+(d.snellen||'--')+'</div><div class="rs-lbl">Predicted Acuity</div></div>'
        +'<div class="res-stat"><div class="rs-val">'+(d.peakSens||'--')+'</div><div class="rs-lbl">Peak Sensitivity</div></div>'
        +'<div class="res-stat"><div class="rs-val">'+(d.peakFreq||'--')+' cpd</div><div class="rs-lbl">Peak Frequency</div></div>'
        +'</div>';

    // Landmark scorecard
    if(d.landmarks&&d.landmarks.length){
        var passed=d.passCount||0,total=d.totalLandmarks||d.landmarks.length;
        c.innerHTML+='<div class="res-section-title">Real-World Vision Score: '+passed+' / '+total+'</div>';
        var html='<div class="res-lm-list">';
        d.landmarks.forEach(function(lm){
            var icon=lm.pass?'\u2713':'\u2717';
            var cls=lm.pass?'lm-pass':'lm-fail';
            html+='<div class="res-lm '+cls+'">'
                +'<div class="lm-icon">'+icon+'</div>'
                +'<div class="lm-info">'
                +'<div class="lm-name">'+lm.name+'</div>'
                +'<div class="lm-ctx">'+lm.context+'</div>'
                +'</div>'
                +'<div class="lm-score">'
                +'<div class="lm-yours">'+lm.yours+'</div>'
                +'<div class="lm-need">'+(lm.pass?lm.margin+'x margin':'need '+lm.needed)+'</div>'
                +'</div>'
                +'</div>';
        });
        html+='</div>';
        c.innerHTML+=html;
    }

    // Plot placeholder (image arrives separately via plotImage message)
    c.innerHTML+='<img class="res-plot" style="display:none" alt="CSF Plot">';

    // Actions
    c.innerHTML+='<div class="res-actions">'
        +'<button class="res-btn primary" onclick="shareR()">Share Results</button>'
        +'<button class="res-btn" onclick="copyR()">Copy Text</button>'
        +'</div>'
        +'<div class="res-copied" id="rcp">Copied</div>';
}

function getRText(){
    if(!resultData)return'';
    var t='Burke Vision Lab Results\n';
    t+='========================\n';
    t+='AULCSF Score: '+resultData.score+'\n';
    t+='Rating: '+resultData.rank+'\n';
    t+='Predicted Acuity: '+(resultData.snellen||'--')+'\n';
    t+='Peak Sensitivity: '+(resultData.peakSens||'--')+' @ '+(resultData.peakFreq||'--')+' cpd\n\n';
    if(resultData.landmarks){
        t+='Real-World Vision Assessment\n';
        t+='----------------------------\n';
        resultData.landmarks.forEach(function(lm){
            t+=(lm.pass?'PASS':'FAIL')+' | '+lm.name+' (yours: '+lm.yours+', need: '+lm.needed+')\n';
            t+='      '+lm.context+'\n';
        });
        t+='\nPassed: '+resultData.passCount+' / '+resultData.totalLandmarks+'\n';
    }
    t+='\nDate: '+new Date().toLocaleDateString('en-US',{year:'numeric',month:'long',day:'numeric'});
    return t;
}
function shareR(){if(!resultData)return;if(navigator.share)navigator.share({title:'Burke Vision Lab Results',text:getRText()}).catch(function(){});else copyR()}
function copyR(){if(!resultData)return;navigator.clipboard.writeText(getRText()).then(function(){var e=document.getElementById('rcp');if(e){e.classList.add('show');setTimeout(function(){e.classList.remove('show')},2000)}}).catch(function(){})}
</script></body></html>
