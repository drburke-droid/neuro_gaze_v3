 (cd "$(git rev-parse --show-toplevel)" && git apply --3way <<'EOF' 
diff --git a/tablet.html b/tablet.html
index 631437bfaf63de04266ea2045af62360661872ed..ffa56eb68116b1eeec694419d4ff98e3d7a018bd 100644
--- a/tablet.html
+++ b/tablet.html
@@ -113,109 +113,152 @@ body{background:var(--c);color:var(--t1);font-family:var(--f);-webkit-font-smoot
 <div class="res-dt" id="rdt"></div>
 <img class="res-plot" id="rplot" style="display:none" alt="CSF">
 <canvas id="rcnv" style="display:none"></canvas>
 <div class="res-actions">
 <button class="res-btn primary" onclick="shareR()">↑ Share</button>
 <button class="res-btn" onclick="copyR()">⎘ Copy</button>
 </div>
 <div class="res-copied" id="rcp">Copied</div>
 </div>
 </div>
 
 <!-- Status -->
 <div class="sbar"><div class="stt" id="stt"><span class="sd sd-wait"></span>Connecting…</div></div>
 <div id="dlog"></div>
 
 <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
 <script>if(typeof Peer==='undefined'){var s=document.createElement('script');s.src='https://cdnjs.cloudflare.com/ajax/libs/peerjs/1.5.2/peerjs.min.js';document.head.appendChild(s)}</script>
 <script>
 function dlog(m){const e=document.getElementById('dlog');if(e){e.textContent+=m+'\n';e.scrollTop=e.scrollHeight}console.log('[T]',m)}
 function setSt(cls,txt){document.getElementById('stt').innerHTML=`<span class="sd ${cls}"></span>${txt}`}
 function setMode(id){document.querySelectorAll('.mode').forEach(m=>m.classList.remove('active'));document.getElementById(id).classList.add('active')}
 
 const P=new URLSearchParams(location.search);
 const targetID=P.get('id');
 let conn=null,isConn=false;
+let attempts=0;
+const MAX_ATTEMPTS=6;
 
 // ═══ Connect ═══
 if(!targetID){setSt('sd-er','No ID — scan QR on display');dlog('No id param')}
 else{
     dlog('Target: '+targetID);
     if(typeof Peer==='undefined'){
         setTimeout(()=>{if(typeof Peer!=='undefined')doConnect();else{setSt('sd-er','PeerJS failed');dlog('Peer still undefined')}},2000);
     }else doConnect();
 }
 
 function doConnect(){
+    attempts++;
     setSt('sd-wait','Connecting…');
+    dlog(`Connect attempt ${attempts}/${MAX_ATTEMPTS}`);
     const p=new Peer(undefined,{debug:1,config:{iceServers:[{urls:'stun:stun.l.google.com:19302'},{urls:'stun:stun1.l.google.com:19302'}]}});
-    const timeout=setTimeout(()=>{if(!isConn){setSt('sd-er','Timed out');dlog('Timeout')}},30000);
+    const timeout=setTimeout(()=>{
+        if(!isConn){
+            dlog('Timeout');
+            p.destroy();
+            retryConnect('Timed out');
+        }
+    },15000);
     p.on('open',myId=>{
         dlog('My ID: '+myId.substring(0,8)+'…');
         conn=p.connect(targetID,{reliable:true});
         conn.on('open',()=>{
             clearTimeout(timeout);isConn=true;
             dlog('CONNECTED');setSt('sd-ok','Linked');
         });
         conn.on('data',onMsg);
         conn.on('close',()=>{isConn=false;dlog('Closed');setSt('sd-er','Disconnected')});
         conn.on('error',e=>{dlog('Conn err: '+e.type);setSt('sd-er','Error: '+e.type)});
     });
-    p.on('error',e=>{clearTimeout(timeout);dlog('Peer err: '+e.type);setSt('sd-er',e.type==='peer-unavailable'?'Display not found':e.type)});
+    p.on('error',e=>{
+        clearTimeout(timeout);
+        dlog('Peer err: '+e.type);
+        p.destroy();
+        retryConnect(e.type==='peer-unavailable'?'Display not found':e.type);
+    });
     p.on('disconnected',()=>{if(!p.destroyed)p.reconnect()});
 }
 
+function retryConnect(reason){
+    if(isConn)return;
+    if(attempts>=MAX_ATTEMPTS){
+        setSt('sd-er',reason);
+        dlog('Giving up after max retries');
+        return;
+    }
+    setSt('sd-wait',`${reason}. Retrying…`);
+    setTimeout(doConnect,1500);
+}
+
 function tx(m){if(conn&&isConn)conn.send(m);else dlog('tx fail: not connected')}
 
 // ═══ Message router ═══
 function onMsg(d){
     if(d.type==='calStep')renderCalStep(d);
     if(d.type==='testStart'){dlog('Test started');setMode('m-test')}
     if(d.type==='progress')updateRing(d.trial,d.maxTrials);
     if(d.type==='results')showResults(d);
 }
 
 // ═══ Calibration UI ═══
 function renderCalStep(d){
     const bd=document.getElementById('cbd'),tl=document.getElementById('ctl'),sl=document.getElementById('csl'),nv=document.getElementById('cnv');
     setMode('m-cal');
     if(d.step===0){
         sl.textContent='STEP 1 · LUMINANCE';tl.textContent='Adjust Brightness';
         bd.innerHTML=`<div class="cal-val" id="gval">${d.gamma||128}</div>
 <div class="cal-slider"><input type="range" id="gsl" min="60" max="220" value="${d.gamma||128}" oninput="onGamma(this.value)"></div>
 <div class="cal-sl"><span>DARKER</span><span>BRIGHTER</span></div>
 <div class="cal-hint">Adjust until circle disappears<br>into the checkerboard on the display</div>`;
         nv.innerHTML='<button class="cal-btn btn-next" onclick="nav(\'next\')">Next →</button>';
     }else if(d.step===1){
         sl.textContent='STEP 2 · SCALE';tl.textContent='Card Size';
         bd.innerHTML=`<div class="cal-msg">Match the card rectangle on the display<br>to a real credit card width.</div>
 <div class="cal-slider"><input type="range" id="csl" min="150" max="750" step="0.1" value="${d.cardPx||300}" oninput="onCard(this.value)"></div>
 <div class="cal-sl"><span>SMALLER</span><span>LARGER</span></div>`;
         nv.innerHTML='<button class="cal-btn btn-back" onclick="nav(\'back\')">← Back</button><button class="cal-btn btn-next" onclick="nav(\'next\')">Next →</button>';
     }else if(d.step===2){
         sl.textContent='STEP 3 · DISTANCE';tl.textContent='Viewing Distance';
-        bd.innerHTML='<div class="cal-msg" style="font-size:1rem">Enter the viewing distance<br>on the display screen.</div>';
+        const distValue=d.distanceValue||'';
+        const distUnit=d.distanceUnit||'ft';
+        bd.innerHTML=`<div class="cal-msg" style="font-size:1rem">Enter the viewing distance here<br>with your phone keyboard.</div>
+<div class="cal-slider" style="display:flex;gap:10px;align-items:center;max-width:340px">
+<input id="dist-input" type="number" inputmode="decimal" step="0.1" min="0" placeholder="e.g. 20" value="${distValue}" style="flex:1;padding:12px 10px;border-radius:10px;border:1px solid rgba(255,255,255,.2);background:rgba(255,255,255,.06);color:#fff;font-size:1rem">
+<select id="dist-unit" style="padding:12px 8px;border-radius:10px;border:1px solid rgba(255,255,255,.2);background:rgba(255,255,255,.06);color:#fff;font-size:1rem">
+<option value="ft" ${distUnit==='ft'?'selected':''}>ft</option>
+<option value="m" ${distUnit==='m'?'selected':''}>m</option>
+<option value="cm" ${distUnit==='cm'?'selected':''}>cm</option>
+<option value="in" ${distUnit==='in'?'selected':''}>in</option>
+</select>
+</div>`;
+        setTimeout(()=>{
+            const din=document.getElementById('dist-input');
+            const du=document.getElementById('dist-unit');
+            if(din)din.addEventListener('input',()=>tx({type:'distance',value:din.value,unit:du?du.value:'ft'}));
+            if(du)du.addEventListener('change',()=>tx({type:'distance',value:din?din.value:'',unit:du.value}));
+        },0);
         nv.innerHTML='<button class="cal-btn btn-back" onclick="nav(\'back\')">← Back</button><button class="cal-btn btn-next" onclick="nav(\'next\')">Review →</button>';
     }else if(d.step===3){
         sl.textContent='STEP 4 · CONFIRM';tl.textContent='Review & Start';
         bd.innerHTML='<div class="cal-msg" style="font-size:1rem">Review settings on the display.<br>Press Start when ready.</div>';
         nv.innerHTML='<button class="cal-btn btn-back" onclick="nav(\'back\')">← Back</button><button class="cal-btn btn-start" onclick="nav(\'start\')">Start Test ▶</button>';
     }
 }
 
 function onGamma(v){document.getElementById('gval').textContent=v;tx({type:'gamma',value:parseInt(v)})}
 function onCard(v){tx({type:'cardSize',value:parseFloat(v)})}
 function nav(to){tx({type:'nav',to:to})}
 // ═══ Test mode ═══
 function send(v){
     if(!isConn){dlog('send: not connected');return}
     tx({type:'input',value:v});
     if(navigator.vibrate)navigator.vibrate(20);
 }
 function updateRing(t,mx){
     document.getElementById('rfg').style.strokeDashoffset=2*Math.PI*21*(1-t/mx);
     document.getElementById('rnum').textContent=t;
 }
 
 // ═══ Results ═══
 let resultData=null;
 function showResults(d){
 
EOF
)