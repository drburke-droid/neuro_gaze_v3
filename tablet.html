<!DOCTYPE html><html lang="en"><head>
<meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover">
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Expires" content="0">
<title>Burke Vision Lab</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:opsz,wght@9..40,300;9..40,400;9..40,500;9..40,600&family=JetBrains+Mono:wght@300;400;500;700&display=swap" rel="stylesheet">
<style>
:root{--a:#00ffcc;--ag:rgba(0,255,204,.25);--as:rgba(0,255,204,.1);--c:#0a0a0c;--b:rgba(255,255,255,.12);--t1:#fff;--t2:rgba(255,255,255,.7);--t3:rgba(255,255,255,.4);--e:#ff453a;--f:'DM Sans',-apple-system,system-ui,sans-serif;--m:'JetBrains Mono','SF Mono',monospace;--ez:cubic-bezier(.22,.68,0,1.04);--ez-out:cubic-bezier(0,.55,.45,1);--ez-spring:cubic-bezier(.34,1.56,.64,1);--ez-btn:cubic-bezier(.25,.1,.25,1);--fade:360ms;--settle:500ms}
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
html{font-size:clamp(150%, 5.5vw, 220%)}
body{background:var(--c);color:var(--t1);font-family:var(--f);-webkit-font-smoothing:antialiased;height:100vh;height:100dvh;overflow:hidden;display:flex;flex-direction:column;padding:env(safe-area-inset-top) 0 env(safe-area-inset-bottom);opacity:0;animation:bodyIn .6s var(--ez-out) .1s forwards}
@keyframes bodyIn{to{opacity:1}}
.hdr{padding:14px 20px 6px;text-align:center;flex-shrink:0}.brand{font-size:1rem;font-weight:300;color:var(--t2);opacity:0;animation:settleUp var(--settle) var(--ez) .2s forwards}

/* ─── Crossfade screen transitions ─── */
.mode{position:absolute;inset:0;top:44px;bottom:40px;display:flex;flex-direction:column;overflow:hidden;opacity:0;visibility:hidden;transform:translateY(6px);transition:opacity var(--fade) var(--ez-out),visibility 0s var(--fade),transform var(--settle) var(--ez);pointer-events:none}
.mode.active{opacity:1;visibility:visible;transform:translateY(0);pointer-events:auto;transition:opacity var(--fade) var(--ez-out) 40ms,visibility 0s 0s,transform var(--settle) var(--ez) 40ms}

/* ─── Status bar ─── */
.sbar{padding:8px 20px;text-align:center;flex-shrink:0;margin-top:auto}
.stt{font-family:var(--m);font-size:.65rem;letter-spacing:1.5px;color:var(--t2);transition:all .4s var(--ez)}
.sd{display:inline-block;width:8px;height:8px;border-radius:50%;margin-right:6px;vertical-align:middle;transition:background .4s var(--ez)}
.sd-ok{background:var(--a);box-shadow:0 0 8px var(--ag);animation:shimmer 3s ease-in-out infinite}
.sd-er{background:var(--e);box-shadow:0 0 6px rgba(255,69,58,.3)}
.sd-wait{background:rgba(255,255,255,.4);animation:pulse 1.8s cubic-bezier(.4,0,.6,1) infinite}
@keyframes pulse{0%,100%{opacity:1;transform:scale(1)}50%{opacity:.2;transform:scale(.85)}}
@keyframes shimmer{0%,100%{box-shadow:0 0 8px var(--ag),0 0 2px var(--a)}50%{box-shadow:0 0 18px var(--ag),0 0 6px rgba(0,255,204,.5)}}
#dlog{font-family:var(--m);font-size:.45rem;color:var(--t3);max-height:36px;overflow-y:auto;padding:0 20px;line-height:1.4}

/* ─── Settle keyframes (elements appear with micro slide-up) ─── */
@keyframes settleUp{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
@keyframes settleScale{from{opacity:0;transform:scale(.92)}to{opacity:1;transform:scale(1)}}
@keyframes popIn{from{opacity:0;transform:scale(.8)}to{opacity:1;transform:scale(1)}}

/* ─── Calibration ─── */
.cal{padding:14px 20px;flex:1;display:flex;flex-direction:column;overflow-y:auto}
.cal-title{font-size:1.15rem;font-weight:300;text-align:center;margin-bottom:2px;opacity:0;animation:settleUp var(--settle) var(--ez) .08s forwards}
.cal-step-label{font-family:var(--m);font-size:.58rem;letter-spacing:2px;text-transform:uppercase;color:var(--t3);text-align:center;margin-bottom:12px;opacity:0;animation:settleUp var(--settle) var(--ez) .04s forwards}
.cal-body{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:12px;opacity:0;animation:settleUp var(--settle) var(--ez) .14s forwards}
.cal-val{font-family:var(--m);font-size:2.4rem;font-weight:500;color:var(--a);transition:color .2s var(--ez)}
.cal-hint{font-size:.82rem;color:var(--t2);text-align:center;line-height:1.6}
.cal-msg{font-size:.88rem;color:var(--t2);text-align:center;padding:12px;line-height:1.7}
.cal-slider{width:94%;max-width:320px;opacity:0;animation:settleUp var(--settle) var(--ez) .2s forwards}
.cal-slider input[type=range]{-webkit-appearance:none;width:100%;height:12px;background:rgba(255,255,255,.15);border-radius:6px;outline:0;transition:background .2s}
.cal-slider input[type=range]::-webkit-slider-thumb{-webkit-appearance:none;width:clamp(32px,10vw,44px);height:clamp(32px,10vw,44px);border-radius:50%;background:var(--a);box-shadow:0 0 20px var(--ag);border:3px solid rgba(0,0,0,.3);transition:transform .2s var(--ez-spring),box-shadow .2s}
.cal-slider input[type=range]:active::-webkit-slider-thumb{transform:scale(1.15);box-shadow:0 0 30px var(--ag)}
.cal-slider input[type=range]::-moz-range-thumb{width:clamp(32px,10vw,44px);height:clamp(32px,10vw,44px);border-radius:50%;background:var(--a);border:3px solid rgba(0,0,0,.3)}
.cal-sl{display:flex;justify-content:space-between;width:94%;max-width:320px;font-family:var(--m);font-size:.58rem;color:var(--t3);text-transform:uppercase;margin-top:3px}
.cal-nav{display:flex;gap:12px;justify-content:center;padding:14px 0;flex-shrink:0;opacity:0;animation:settleUp var(--settle) var(--ez) .24s forwards}

/* ─── Buttons — physical haptic feel ─── */
.cal-btn{padding:clamp(12px,3.5vw,18px) clamp(24px,8vw,40px);border-radius:100px;font-family:var(--f);font-size:clamp(.75rem,2.5vw,1rem);cursor:pointer;border:none;transition:transform .15s var(--ez-spring),background .2s var(--ez),box-shadow .2s var(--ez),border-color .2s;-webkit-tap-highlight-color:transparent;touch-action:manipulation;will-change:transform}
.cal-btn:active{transform:scale(.92) translateY(1px)}
.btn-back{background:0;color:var(--t2);border:2px solid var(--b)}
.btn-back:active{background:rgba(255,255,255,.04);border-color:rgba(255,255,255,.2)}
.btn-next{background:#fff;color:#0a0a0c;box-shadow:0 2px 12px rgba(255,255,255,.1)}
.btn-next:active{background:var(--a);transform:scale(.92) translateY(1px);box-shadow:0 0 20px var(--ag)}
.btn-start{background:var(--a);color:#0a0a0c;font-weight:500;font-size:clamp(.9rem,3vw,1.1rem);padding:clamp(14px,4vw,22px) clamp(36px,12vw,56px);box-shadow:0 4px 24px var(--ag)}
.btn-start:active{transform:scale(.93) translateY(2px);box-shadow:0 1px 8px var(--ag)}
.btn-mirror{padding:15px 28px;border-radius:18px;font-size:1.02rem;font-weight:500;cursor:pointer;border:2px solid var(--b);background:rgba(255,255,255,.03);color:var(--t1);-webkit-tap-highlight-color:transparent;touch-action:manipulation;transition:transform .15s var(--ez-spring),border-color .2s,background .2s,color .2s,box-shadow .2s}
.btn-mirror:active{transform:scale(.93) translateY(1px);border-color:var(--a);background:var(--as);color:var(--a);box-shadow:0 0 16px var(--ag)}
.ph-dist-input{padding:14px 20px;border-radius:14px;border:2px solid var(--b);background:rgba(0,0,0,.3);color:var(--t1);font-family:var(--m);font-size:clamp(1.1rem,4vw,1.6rem);width:clamp(80px,25vw,120px);text-align:center;outline:0;transition:border-color .3s var(--ez),box-shadow .3s var(--ez)}
.ph-dist-input:focus{border-color:var(--a);box-shadow:0 0 16px rgba(0,255,204,.12)}
.ph-dist-select{padding:14px;border-radius:14px;border:2px solid var(--b);background:rgba(0,0,0,.3);color:var(--t1);font-family:var(--m);font-size:clamp(.85rem,3vw,1.1rem);outline:0;transition:border-color .3s var(--ez)}.ph-dist-select option{background:#222;color:#fff}

/* ─── Phone summary table ─── */
.ph-sum-table{width:100%;border-collapse:collapse;margin:0 auto}
.ph-sum-table tr+tr .ph-sum-l,.ph-sum-table tr+tr .ph-sum-v{padding-top:6px}
.ph-sum-l{font-size:.88rem;color:var(--t2);font-weight:300;padding-right:14px;text-align:left;white-space:nowrap}
.ph-sum-v{font-family:var(--m);font-size:.88rem;font-weight:500;color:var(--a);text-align:right}
.ph-ppd-warn{margin-top:12px;padding:10px 14px;border-radius:10px;background:rgba(255,179,0,.1);border:1px solid rgba(255,179,0,.25);color:#ffb300;font-family:var(--m);font-size:.78rem;text-align:center;line-height:1.5}

/* ─── Tutorial ─── */
.tut{padding:16px;flex:1;display:flex;flex-direction:column;align-items:center;overflow-y:auto}
.tut-title{font-size:1.02rem;font-weight:300;text-align:center;margin-bottom:4px}
.tut-sub{font-size:.78rem;color:var(--t2);text-align:center;margin-bottom:12px}
.tut-grid{display:flex;flex-direction:column;gap:10px;width:min(94vw,360px)}
.tut-row{display:flex;gap:10px}
.tut-btn{flex:1;padding:clamp(14px,4vw,22px) clamp(8px,2.5vw,16px);border-radius:18px;border:2px solid var(--b);background:rgba(255,255,255,.03);text-align:center;display:flex;flex-direction:column;align-items:center;gap:5px;cursor:pointer;-webkit-tap-highlight-color:transparent;touch-action:manipulation;transition:transform .15s var(--ez-spring),opacity .3s var(--ez),border-color .25s,background .25s,box-shadow .3s;will-change:transform}
.tut-btn:active{transform:scale(.9) translateY(1px)}
.tut-btn .arrow{font-size:clamp(1.3rem,5vw,1.9rem);color:var(--t1);transition:color .25s}.tut-btn .lbl{font-family:var(--m);font-size:.58rem;color:var(--t2);letter-spacing:1px}
.tut-btn.dim{opacity:.15;pointer-events:none;transform:scale(.97)}
.tut-btn.hl{border-color:var(--e);background:rgba(255,69,58,.12);box-shadow:0 0 20px rgba(255,69,58,.3);animation:hlP 1.2s ease-in-out infinite,settleScale .35s var(--ez-spring)}.tut-btn.hl .arrow{color:var(--e)}
@keyframes hlP{0%,100%{box-shadow:0 0 14px rgba(255,69,58,.2)}50%{box-shadow:0 0 28px rgba(255,69,58,.5)}}
.tut-no{padding:18px;border-radius:18px;border:2px solid rgba(255,255,255,.08);background:rgba(255,255,255,.02);font-size:1rem;color:var(--t2);text-align:center;cursor:pointer;touch-action:manipulation;-webkit-tap-highlight-color:transparent;transition:transform .15s var(--ez-spring),opacity .3s var(--ez),border-color .25s,background .25s,box-shadow .3s,color .25s;will-change:transform}
.tut-no:active{transform:scale(.95) translateY(1px)}
.tut-no.dim{opacity:.15;pointer-events:none;transform:scale(.97)}
.tut-no.hl{border-color:var(--e);background:rgba(255,69,58,.12);box-shadow:0 0 20px rgba(255,69,58,.3);color:var(--e);animation:hlP 1.2s ease-in-out infinite,settleScale .35s var(--ez-spring)}
.tut-dots{display:flex;gap:6px;justify-content:center;margin-top:10px}
.tut-dot{width:8px;height:8px;border-radius:50%;background:rgba(255,255,255,.15);transition:background .4s var(--ez),box-shadow .4s var(--ez),transform .3s var(--ez-spring)}.tut-dot.active{background:var(--a);box-shadow:0 0 8px var(--ag);transform:scale(1.25)}
.tut-inst{font-family:var(--m);font-size:.52rem;color:var(--t3);text-align:center;margin-top:6px;letter-spacing:1px}

/* ─── Pre-test questionnaire ─── */
.pretest-ph{padding:20px 16px;flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:18px}
.pretest-ph-title{font-family:var(--m);font-size:.78rem;letter-spacing:3px;text-transform:uppercase;color:var(--t3)}
.pretest-ph-group{display:flex;flex-direction:column;align-items:center;gap:8px;width:100%}
.pretest-ph-q{font-size:.92rem;font-weight:300;color:var(--t2)}
.pretest-ph-opts{display:flex;gap:8px;width:min(94vw,360px)}
.pretest-ph-btn{flex:1;padding:clamp(12px,3.5vw,18px) 8px;border-radius:16px;border:2px solid var(--b);background:rgba(255,255,255,.03);font-family:var(--f);font-size:clamp(.78rem,2.5vw,.95rem);font-weight:500;color:var(--t1);cursor:pointer;text-align:center;-webkit-tap-highlight-color:transparent;touch-action:manipulation;transition:transform .15s var(--ez-spring),border-color .25s,background .25s,color .25s,box-shadow .25s}
.pretest-ph-btn:active{transform:scale(.93) translateY(1px)}
.pretest-ph-btn.selected{border-color:var(--a);background:var(--as);color:var(--a);box-shadow:0 0 16px rgba(0,255,204,.15)}
.pretest-ph-go{padding:clamp(14px,4vw,20px) clamp(36px,12vw,56px);border-radius:100px;border:none;background:var(--a);color:#0a0a0c;font-family:var(--f);font-size:clamp(.9rem,3vw,1.1rem);font-weight:500;cursor:pointer;box-shadow:0 4px 24px var(--ag);-webkit-tap-highlight-color:transparent;touch-action:manipulation;transition:transform .15s var(--ez-spring),opacity .3s}
.pretest-ph-go:disabled{opacity:.2;pointer-events:none}
.pretest-ph-go:active{transform:scale(.93) translateY(2px)}

/* ─── Test — haptic button feel ───
   Haptic: navigator.vibrate() works on Android Chrome. iOS Safari does NOT
   support vibrate() — no web API exists for haptic on iOS. The if-guard
   (if(navigator.vibrate)) already handles this gracefully. CSS :active scale
   transforms provide visual "press" feedback on all platforms. True iOS haptic
   would require a native wrapper (Capacitor Haptics plugin). */
.test{padding:0 16px;flex:1;display:flex;flex-direction:column}
.test-prog{display:flex;justify-content:center;padding:8px 0;flex-shrink:0;opacity:0;animation:settleUp var(--settle) var(--ez) .1s forwards}
.ring{position:relative;width:56px;height:56px}.ring svg{width:56px;height:56px;transform:rotate(-90deg)}
.ring .bg{fill:none;stroke:rgba(255,255,255,.06);stroke-width:3}.ring .fg{fill:none;stroke:var(--a);stroke-width:3;stroke-linecap:round;stroke-dasharray:131.9;stroke-dashoffset:131.9;transition:stroke-dashoffset .6s var(--ez);filter:drop-shadow(0 0 3px var(--ag))}
.ring .num{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;font-family:var(--m);font-size:.9rem;font-weight:500;color:var(--t1);transition:transform .2s var(--ez-spring)}
.test-resp{flex:1;display:flex;align-items:center;justify-content:center;opacity:0;animation:settleUp var(--settle) var(--ez) .18s forwards}
.ori-pad{display:flex;flex-direction:column;gap:clamp(8px,2.5vw,14px);width:min(94vw,420px)}
.ori-row{display:flex;gap:clamp(8px,2.5vw,14px)}
.ori-btn{flex:1;padding:clamp(16px,5vw,26px) clamp(10px,3vw,18px);border-radius:20px;border:2px solid var(--b);background:rgba(255,255,255,.03);font-size:clamp(1.4rem,5vw,2rem);color:var(--t1);cursor:pointer;-webkit-tap-highlight-color:transparent;touch-action:manipulation;text-align:center;display:flex;flex-direction:column;align-items:center;gap:clamp(4px,1.5vw,8px);will-change:transform;transition:transform .12s var(--ez-spring),background .15s,border-color .15s,color .15s,box-shadow .15s}
.ori-btn:active,.ori-btn.flash{transform:scale(.88) translateY(2px);background:var(--as);border-color:var(--a);color:var(--a);box-shadow:inset 0 2px 6px rgba(0,0,0,.3),0 0 12px var(--ag)}
.ori-lbl{font-family:var(--m);font-size:clamp(.5rem,1.8vw,.65rem);letter-spacing:1px;text-transform:uppercase;color:var(--t2);transition:color .15s}
.no-btn{padding:20px;border-radius:20px;border:2px solid rgba(255,255,255,.08);background:rgba(255,255,255,.02);font-size:1.1rem;color:var(--t2);cursor:pointer;-webkit-tap-highlight-color:transparent;touch-action:manipulation;text-align:center;will-change:transform;transition:transform .12s var(--ez-spring),background .15s,border-color .15s,color .15s,box-shadow .15s}
.no-btn:active,.no-btn.flash{transform:scale(.93) translateY(2px);background:rgba(255,69,58,.08);border-color:rgba(255,69,58,.3);color:var(--e);box-shadow:inset 0 2px 4px rgba(0,0,0,.2)}

/* ─── Results — staggered reveal ─── */
.res{padding:16px 20px;flex:1;display:flex;flex-direction:column;align-items:center;gap:6px;overflow-y:auto}
.res-ey{font-family:var(--m);font-size:.6rem;letter-spacing:3px;text-transform:uppercase;color:rgba(255,255,255,.5);opacity:0;animation:settleUp var(--settle) var(--ez) .1s forwards}
.res-sc{font-family:var(--m);font-size:clamp(2.4rem,10vw,3.6rem);font-weight:700;color:var(--a);line-height:1;text-shadow:0 0 60px var(--ag);opacity:0;animation:popIn .6s var(--ez-spring) .25s forwards}
.res-rk{font-size:.95rem;font-weight:300;letter-spacing:5px;text-transform:uppercase;color:rgba(255,255,255,.55);margin-bottom:6px;opacity:0;animation:settleUp var(--settle) var(--ez) .4s forwards}
.res-stats{display:flex;gap:6px;width:100%;margin:6px 0;opacity:0;animation:settleUp var(--settle) var(--ez) .5s forwards}
.res-stat{flex:1;padding:clamp(8px,2vw,14px) clamp(4px,1.5vw,8px);border-radius:12px;border:1px solid var(--b);background:rgba(255,255,255,.02);text-align:center;transition:border-color .3s}
.rs-val{font-family:var(--m);font-size:clamp(.85rem,3vw,1.2rem);font-weight:600;color:var(--a)}
.rs-lbl{font-size:.55rem;color:var(--t3);margin-top:2px;letter-spacing:.5px}
.res-plot{width:100%;max-width:380px;border-radius:8px;margin:8px 0;opacity:0;animation:settleUp var(--settle) var(--ez) .8s forwards}
.res-actions{display:flex;gap:10px;margin-top:6px;opacity:0;animation:settleUp var(--settle) var(--ez) .9s forwards}
.res-btn{padding:12px 24px;border-radius:100px;border:1.5px solid var(--b);background:0;color:var(--t2);font-size:.78rem;cursor:pointer;display:flex;align-items:center;gap:6px;font-family:var(--f);-webkit-tap-highlight-color:transparent;touch-action:manipulation;will-change:transform;transition:transform .12s var(--ez-spring),background .2s,border-color .2s,color .2s,box-shadow .2s}
.res-btn:active{transform:scale(.93) translateY(1px);background:var(--as);border-color:var(--a);color:var(--a);box-shadow:0 0 12px var(--ag)}
.res-btn.primary{background:var(--as);border-color:rgba(0,255,204,.25);color:var(--a)}
.res-copied{font-family:var(--m);font-size:.5rem;color:var(--a);opacity:0;transition:opacity .4s var(--ez),transform .4s var(--ez);transform:translateY(4px)}.res-copied.show{opacity:1;transform:translateY(0)}

/* ─── Explorer CTA + copy button ─── */
.csf-formula-copy{padding:8px 20px;border-radius:100px;border:1.5px solid var(--b);background:0;color:var(--t2);font-family:var(--f);font-size:.68rem;cursor:pointer;-webkit-tap-highlight-color:transparent;touch-action:manipulation;transition:transform .12s var(--ez-spring),background .2s,border-color .2s,color .2s}
.csf-formula-copy:active{transform:scale(.93) translateY(1px);background:var(--as);border-color:var(--a);color:var(--a)}
.explorer-cta-card{width:100%;padding:18px 16px;border-radius:14px;border:1.5px solid rgba(0,255,204,.2);background:rgba(0,255,204,.03);text-align:center;display:flex;flex-direction:column;align-items:center;gap:10px}
.explorer-cta-label{font-family:var(--f);font-size:clamp(.85rem,3vw,1.05rem);font-weight:500;color:var(--t1)}
.explorer-cta-desc{font-size:clamp(.62rem,2vw,.75rem);color:var(--t2);line-height:1.6;font-weight:300;max-width:360px}
.explorer-cta-btn{display:inline-block;padding:12px 28px;border-radius:100px;border:2px solid rgba(0,255,204,.35);background:rgba(0,255,204,.08);color:var(--a);font-family:var(--f);font-size:clamp(.72rem,2.4vw,.88rem);font-weight:600;text-decoration:none;letter-spacing:.3px;-webkit-tap-highlight-color:transparent;touch-action:manipulation;transition:transform .12s var(--ez-spring),background .2s}
.explorer-cta-btn:active{transform:scale(.93) translateY(1px);background:rgba(0,255,204,.18)}
.explorer-cta-note{font-family:var(--m);font-size:clamp(.5rem,1.6vw,.62rem);color:var(--a);opacity:.6;letter-spacing:.3px}
.explorer-cta-divider{width:80%;height:1px;background:rgba(255,255,255,.08);margin:4px 0}
.email-self-btn{font-family:var(--f)}
</style></head><body>
<div class="hdr"><span class="brand">Burke Vision Lab</span></div>

<div id="m-cal" class="mode active">
<div class="cal">
<div class="cal-step-label" id="csl"></div>
<div class="cal-title" id="ctl"></div>
<div class="cal-body" id="cbd"></div>
<div class="cal-nav" id="cnv"></div>
</div></div>

<div id="m-tut" class="mode">
<div class="tut">
<div class="tut-title" id="ttl">Orientation Demo</div>
<div class="tut-sub" id="tsub">Press the highlighted button</div>
<div class="tut-grid">
<div class="tut-row">
<div class="tut-btn dim" id="tb-12oclock" onclick="tutTap('12oclock')"><span class="arrow" style="display:inline-block;width:24px;height:24px;border-left:3px solid currentColor;transform:rotate(0deg)"></span><span class="lbl">12</span></div>
<div class="tut-btn dim" id="tb-1oclock" onclick="tutTap('1oclock')"><span class="arrow" style="display:inline-block;width:24px;height:24px;border-left:3px solid currentColor;transform:rotate(30deg)"></span><span class="lbl">1</span></div>
<div class="tut-btn dim" id="tb-2oclock" onclick="tutTap('2oclock')"><span class="arrow" style="display:inline-block;width:24px;height:24px;border-left:3px solid currentColor;transform:rotate(60deg)"></span><span class="lbl">2</span></div>
</div>
<div class="tut-row">
<div class="tut-btn dim" id="tb-3oclock" onclick="tutTap('3oclock')"><span class="arrow" style="display:inline-block;width:24px;height:24px;border-left:3px solid currentColor;transform:rotate(90deg)"></span><span class="lbl">3</span></div>
<div class="tut-btn dim" id="tb-4oclock" onclick="tutTap('4oclock')"><span class="arrow" style="display:inline-block;width:24px;height:24px;border-left:3px solid currentColor;transform:rotate(120deg)"></span><span class="lbl">4</span></div>
<div class="tut-btn dim" id="tb-5oclock" onclick="tutTap('5oclock')"><span class="arrow" style="display:inline-block;width:24px;height:24px;border-left:3px solid currentColor;transform:rotate(150deg)"></span><span class="lbl">5</span></div>
</div>
<div class="tut-no dim" id="tb-none" onclick="tutTap('none')">No Target</div>
</div>
<div class="tut-dots" id="tdots"></div>
<div class="tut-inst" id="tinst">Look at the display</div>
</div></div>

<div id="m-pretest" class="mode">
<div class="pretest-ph">
<div class="pretest-ph-title">Before we begin</div>
<div class="pretest-ph-group">
<div class="pretest-ph-q">Which eye(s) are being tested?</div>
<div class="pretest-ph-opts" id="ph-pt-eye">
<button class="pretest-ph-btn" onclick="ptPick('eye',this,'right')">Right</button>
<button class="pretest-ph-btn" onclick="ptPick('eye',this,'left')">Left</button>
<button class="pretest-ph-btn" onclick="ptPick('eye',this,'both')">Both</button>
</div>
</div>
<div class="pretest-ph-group">
<div class="pretest-ph-q">Corrective lenses?</div>
<div class="pretest-ph-opts" id="ph-pt-corr">
<button class="pretest-ph-btn" onclick="ptPick('corr',this,'glasses')">Glasses</button>
<button class="pretest-ph-btn" onclick="ptPick('corr',this,'contacts')">Contacts</button>
<button class="pretest-ph-btn" onclick="ptPick('corr',this,'none')">None</button>
</div>
</div>
<button class="pretest-ph-go" id="ph-pt-go" disabled onclick="ptSubmit()">Continue</button>
</div>
</div>

<div id="m-test" class="mode">
<div class="test">
<div class="test-prog"><div class="ring"><svg viewBox="0 0 48 48"><circle class="bg" cx="24" cy="24" r="21"/><circle class="fg" id="rfg" cx="24" cy="24" r="21"/></svg><div class="num" id="rnum">0</div></div></div>
<div class="test-resp">
<div class="ori-pad">
<div class="ori-row">
<button class="ori-btn" onclick="send('12oclock',event)"><span style="display:inline-block;width:28px;height:28px;border-left:3px solid currentColor;transform:rotate(0deg)"></span><span class="ori-lbl">12</span></button>
<button class="ori-btn" onclick="send('1oclock',event)"><span style="display:inline-block;width:28px;height:28px;border-left:3px solid currentColor;transform:rotate(30deg)"></span><span class="ori-lbl">1</span></button>
<button class="ori-btn" onclick="send('2oclock',event)"><span style="display:inline-block;width:28px;height:28px;border-left:3px solid currentColor;transform:rotate(60deg)"></span><span class="ori-lbl">2</span></button>
</div>
<div class="ori-row">
<button class="ori-btn" onclick="send('3oclock',event)"><span style="display:inline-block;width:28px;height:28px;border-left:3px solid currentColor;transform:rotate(90deg)"></span><span class="ori-lbl">3</span></button>
<button class="ori-btn" onclick="send('4oclock',event)"><span style="display:inline-block;width:28px;height:28px;border-left:3px solid currentColor;transform:rotate(120deg)"></span><span class="ori-lbl">4</span></button>
<button class="ori-btn" onclick="send('5oclock',event)"><span style="display:inline-block;width:28px;height:28px;border-left:3px solid currentColor;transform:rotate(150deg)"></span><span class="ori-lbl">5</span></button>
</div>
<button class="no-btn" onclick="send('none',event)">No Target Visible</button>
</div></div>
</div></div>

<div id="m-res" class="mode">
<div class="res" id="result-content">
</div></div>

<div class="sbar"><div class="stt" id="stt"><span class="sd sd-wait"></span>Connecting...</div></div>
<div id="dlog"></div>

<script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js?v=2"></script>
<script>
// Safari fallback CDN
if(typeof Peer==='undefined'){var s=document.createElement('script');s.src='https://cdnjs.cloudflare.com/ajax/libs/peerjs/1.5.2/peerjs.min.js?v=2';document.head.appendChild(s)}
</script>
<script>
var ICE=[{urls:'stun:stun.l.google.com:19302'},{urls:'stun:stun1.l.google.com:19302'},{urls:'stun:stun2.l.google.com:19302'},{urls:'stun:stun3.l.google.com:19302'},{urls:'stun:stun4.l.google.com:19302'}];

function dlog(m){var e=document.getElementById('dlog');if(e){e.textContent+=m+'\n';e.scrollTop=e.scrollHeight}console.log('[T]',m)}
function setSt(cls,txt){document.getElementById('stt').innerHTML='<span class="sd '+cls+'"></span>'+txt}
function setMode(id){
    var modes=document.querySelectorAll('.mode');
    modes.forEach(function(m){m.classList.remove('active')});
    var target=document.getElementById(id);
    target.classList.add('active');
    // Re-trigger settle animations for child elements
    target.querySelectorAll('.cal-step-label,.cal-title,.cal-body,.cal-nav,.test-prog,.test-resp').forEach(function(el){
        el.style.animation='none';el.offsetHeight;el.style.animation='';
    });
}

// Destroy any stale peer from previous session (Safari caches WebRTC state)
try{if(window._stalePeer&&!window._stalePeer.destroyed)window._stalePeer.destroy()}catch(e){}

var P=new URLSearchParams(location.search),targetID=P.get('id');
// Support ?code=XXXX shorthand (converts to bvl-xxxx PeerJS ID)
if(!targetID){var codeParam=P.get('code');if(codeParam&&codeParam.length===4){targetID='bvl-'+codeParam.toLowerCase()}}
var conn=null,isConn=false,peer=null;

if(!targetID){setSt('sd-er','No display ID');dlog('No id in URL');document.getElementById('cbd').innerHTML='<div class="cal-msg">Open the main site on your display device first, then scan the QR code or enter the pairing code.</div>'}
else{dlog('Target: '+targetID);waitForPeer()}

function waitForPeer(){
    if(typeof Peer!=='undefined'){doConnect();return}
    var tries=0;
    var iv=setInterval(function(){
        tries++;
        if(typeof Peer!=='undefined'){clearInterval(iv);doConnect()}
        else if(tries>50){clearInterval(iv);setSt('sd-er','PeerJS failed to load');dlog('PeerJS never loaded')}
    },200);
}

var reconnAttempts=0;
var MAX_RETRIES=8;

function doConnect(){
    if(peer&&!peer.destroyed){try{peer.destroy()}catch(e){}}
    setSt('sd-wait','Connecting'+(reconnAttempts>0?' (attempt '+(reconnAttempts+1)+')':'')+'...');
    var myId='csf'+Date.now().toString(36)+Math.random().toString(36).slice(2,6);
    peer=new Peer(myId,{debug:0,config:{iceServers:ICE}});
    window._stalePeer=peer;

    var timeout=setTimeout(function(){
        if(!isConn){dlog('15s timeout');tryReconnect()}
    },15000);

    peer.on('open',function(id){
        dlog('My ID: '+id.substring(0,10));
        conn=peer.connect(targetID,{reliable:true,serialization:'json'});
        conn.on('open',function(){
            clearTimeout(timeout);isConn=true;reconnAttempts=0;
            dlog('CONNECTED');setSt('sd-ok','Linked');
        });
        conn.on('data',onMsg);
        conn.on('close',function(){isConn=false;setSt('sd-er','Disconnected');tryReconnect()});
        conn.on('error',function(e){dlog('Conn err: '+(e.type||e))});
    });
    peer.on('error',function(e){
        clearTimeout(timeout);
        dlog('Peer err: '+e.type);
        if(e.type==='peer-unavailable'){
            // Display may not be registered yet — retry after a delay
            dlog('Display not found, will retry...');
            tryReconnect()
        }
        else if(e.type==='unavailable-id'){
            // Our own ID collided — retry immediately with new ID
            dlog('ID collision, retrying...');
            doConnect()
        }
        else{setSt('sd-er','Error: '+e.type);tryReconnect()}
    });
    peer.on('disconnected',function(){if(!peer.destroyed)peer.reconnect()});
}

function tryReconnect(){
    if(reconnAttempts>=MAX_RETRIES){setSt('sd-er','Could not connect. Reload page to try again.');return}
    reconnAttempts++;
    dlog('Retry #'+reconnAttempts+'/'+MAX_RETRIES);
    setSt('sd-wait','Retrying ('+reconnAttempts+'/'+MAX_RETRIES+')...');
    if(peer&&!peer.destroyed){try{peer.destroy()}catch(e){}}
    // Exponential backoff: 1s, 2s, 3s, 4s... capped at 5s
    var delay=Math.min(reconnAttempts*1000,5000);
    setTimeout(doConnect,delay);
}

// Clean up on page hide/unload to avoid stale broker entries
window.addEventListener('pagehide',function(){
    if(peer&&!peer.destroyed){try{peer.destroy()}catch(e){}}
});

function tx(m){if(conn&&isConn)conn.send(m);else dlog('tx fail: not connected')}

function onMsg(d){
    if(d.type==='calStep')renderCalStep(d);
    if(d.type==='calSummary')renderCalSummary(d);
    if(d.type==='mirrorSet')dlog('Mirror: '+d.value);
    if(d.type==='tutStep')renderTutStep(d);
    if(d.type==='preTest'){setMode('m-pretest');ptReset()}
    if(d.type==='testStart'){dlog('Test started');setMode('m-test')}
    if(d.type==='progress')updateRing(d.trial,d.maxTrials);
    if(d.type==='results'){dlog('Results received');showResults(d)}
    if(d.type==='plotImage'){
        var img=document.querySelector('.res-plot');
        if(img){img.src=d.url;img.style.display='block'}
        else{
            var c=document.getElementById('result-content');
            if(c){var i=document.createElement('img');i.className='res-plot';i.src=d.url;i.alt='CSF Plot';c.insertBefore(i,c.querySelector('.res-actions'))}
        }
    }
}

// ═══ Calibration ═══
var distTimer=null;

function renderCalStep(d){
    var bd=document.getElementById('cbd'),tl=document.getElementById('ctl'),sl=document.getElementById('csl'),nv=document.getElementById('cnv');
    setMode('m-cal');
    if(d.step===0){
        sl.textContent='STEP 1 / SCALE';tl.textContent='Card Size';
        bd.innerHTML='<div class="cal-msg">We need to measure your screen\'s pixel density. Hold any wallet card (loyalty, ID, or credit card) flat against the display and use the slider until the white rectangle matches the card\'s width exactly.</div>'
            +'<div class="cal-slider"><input type="range" id="csl2" min="150" max="750" step="0.1" value="'+(d.cardPx||300)+'" oninput="onCard(this.value)"></div>'
            +'<div class="cal-sl"><span>SMALLER</span><span>LARGER</span></div>';
        nv.innerHTML='<button class="cal-btn btn-next" onclick="nav(\'next\')">Next</button>';
    }else if(d.step===1){
        sl.textContent='STEP 2 / SETUP';tl.textContent='Mirror Setup';
        bd.innerHTML='<div class="cal-msg">Is the display being viewed directly, or reflected in a mirror? Mirror mode flips the image so it reads correctly in the reflection.</div>'
            +'<div style="display:flex;gap:14px;justify-content:center;margin-top:6px">'
            +'<button class="btn-mirror" onclick="sendMirror(false)">Direct View</button>'
            +'<button class="btn-mirror" onclick="sendMirror(true)">Mirror View</button></div>';
        nv.innerHTML='<button class="cal-btn btn-back" onclick="nav(\'back\')">Back</button>';
    }else if(d.step===2){
        sl.textContent='STEP 3 / LUMINANCE';tl.textContent='Brightness';
        bd.innerHTML='<div class="cal-val" id="gval">'+(d.gamma||128)+'</div>'
            +'<div class="cal-slider"><input type="range" id="gsl" min="60" max="220" value="'+(d.gamma||128)+'" oninput="onGamma(this.value)"></div>'
            +'<div class="cal-sl"><span>DARKER</span><span>BRIGHTER</span></div>'
            +'<div class="cal-hint">This calibrates screen brightness for accurate contrast measurements.</div>'
            +'<div class="cal-hint">Adjust until circle disappears into checkerboard</div>';
        nv.innerHTML='<button class="cal-btn btn-back" onclick="nav(\'back\')">Back</button><button class="cal-btn btn-next" onclick="nav(\'next\')">Next</button>';
    }else if(d.step===3){
        sl.textContent='STEP 4 / DISTANCE';tl.textContent='Viewing Distance';
        bd.innerHTML='<div class="cal-hint" style="margin-bottom:10px">Measure from the patient\'s eyes to the display screen. Accuracy matters — this sets the spatial frequency scale for the test.</div>'
            +'<div style="display:flex;gap:10px;align-items:center;justify-content:center">'
            +'<input type="number" class="ph-dist-input" id="pdv" placeholder="" min="0.1" step="0.1" inputmode="decimal" oninput="onDistInput()" onchange="onDistInput()">'
            +'<select class="ph-dist-select" id="pdu" onchange="onDistInput()"><option value="ft">feet</option><option value="m">meters</option><option value="cm">cm</option><option value="in">inches</option></select></div>'
            +'<div class="cal-hint">Minimum 15 ft required. 20 ft+ preferred for clinical accuracy.</div>';
        nv.innerHTML='<button class="cal-btn btn-back" onclick="nav(\'back\')">Back</button><button class="cal-btn btn-next" onclick="nav(\'next\')">Review</button>';
    }else if(d.step===4){
        sl.textContent='STEP 5 / CONFIRM';tl.textContent='Review';
        bd.innerHTML='<div id="ph-summary"><div class="cal-msg" style="font-size:1rem">Calculating summary\u2026</div></div>';
        nv.innerHTML='<button class="cal-btn btn-back" onclick="nav(\'back\')">Back</button><button class="cal-btn btn-start" onclick="nav(\'start\')">Start Test</button>';
    }
}

function renderCalSummary(d){
    var el=document.getElementById('ph-summary');
    if(!el)return;
    var ppdColor=d.ppdWarning?'#ffb300':'#00ffcc';
    var html='<table class="ph-sum-table">'
        +'<tr><td class="ph-sum-l">Mirror</td><td class="ph-sum-v">'+(d.mirror?'On':'Off')+'</td></tr>'
        +'<tr><td class="ph-sum-l">Gamma</td><td class="ph-sum-v">'+d.gamma+'</td></tr>'
        +'<tr><td class="ph-sum-l">Scale</td><td class="ph-sum-v">'+d.ppm+' px/mm</td></tr>'
        +'<tr><td class="ph-sum-l">Distance</td><td class="ph-sum-v">'+d.distance+' = '+d.distM+' m</td></tr>'
        +'<tr><td class="ph-sum-l" style="padding-top:10px;border-top:1px solid rgba(255,255,255,.08)">Resolution</td>'
        +'<td class="ph-sum-v" style="padding-top:10px;border-top:1px solid rgba(255,255,255,.08);color:'+ppdColor+'">'+d.ppd+' px/deg</td></tr>'
        +'</table>';
    if(d.ppdWarning){
        html+='<div class="ph-ppd-warn">PPD outside typical range (50\u2013800) \u2014 double-check card scale and distance</div>';
    }
    el.innerHTML=html;
}

function onGamma(v){document.getElementById('gval').textContent=v;tx({type:'gamma',value:parseInt(v)})}
function onCard(v){tx({type:'cardSize',value:parseFloat(v)})}
function nav(to){tx({type:'nav',to:to})}
function sendMirror(v){tx({type:'mirror',value:v})}

function onDistInput(){
    clearTimeout(distTimer);
    distTimer=setTimeout(function(){
        var v=document.getElementById('pdv').value;
        var u=document.getElementById('pdu').value;
        if(v&&!isNaN(parseFloat(v))&&parseFloat(v)>0){
            tx({type:'distance',value:parseFloat(v),unit:u});
        }
    },300);
}

// ═══ Tutorial ═══
var curTutKey=null;
function renderTutStep(d){
    setMode('m-tut');curTutKey=d.key;
    document.getElementById('ttl').textContent='Demo '+(d.stepIdx+1)+' of '+d.total;
    document.getElementById('tsub').textContent=d.stepIdx<d.total-1?'Press '+d.arrow+' '+d.name:'Complete this step to begin';

    var allIds=['tb-12oclock','tb-1oclock','tb-2oclock','tb-3oclock','tb-4oclock','tb-5oclock','tb-none'];
    allIds.forEach(function(id){
        var el=document.getElementById(id);
        el.classList.remove('hl');
        el.classList.add('dim');
    });
    var map={'12oclock':'tb-12oclock','1oclock':'tb-1oclock','2oclock':'tb-2oclock','3oclock':'tb-3oclock','4oclock':'tb-4oclock','5oclock':'tb-5oclock',none:'tb-none'};
    var t=document.getElementById(map[d.key]);
    if(t){t.classList.remove('dim');t.classList.add('hl')}

    var dots=document.getElementById('tdots');dots.innerHTML='';
    for(var i=0;i<d.total;i++){
        var dot=document.createElement('div');
        dot.className='tut-dot'+(i===d.stepIdx?' active':'');
        dots.appendChild(dot);
    }
     document.getElementById('tinst').textContent=d.stepIdx<d.total-1?'Press the highlighted button':'Tap the highlighted button to start testing';
}

function tutTap(key){if(key===curTutKey){tx({type:'input',value:key});if(navigator.vibrate)navigator.vibrate([6,20,3])}}

// ═══ Pre-Test ═══
var ptEye=null,ptCorr=null;
function ptReset(){ptEye=null;ptCorr=null;
    document.querySelectorAll('.pretest-ph-btn').forEach(function(b){b.classList.remove('selected')});
    document.getElementById('ph-pt-go').disabled=true}
function ptPick(field,btn,val){
    var group=btn.parentElement;
    group.querySelectorAll('.pretest-ph-btn').forEach(function(b){b.classList.remove('selected')});
    btn.classList.add('selected');
    if(field==='eye')ptEye=val;else ptCorr=val;
    document.getElementById('ph-pt-go').disabled=!(ptEye&&ptCorr)}
function ptSubmit(){if(!ptEye||!ptCorr)return;
    tx({type:'preTestAnswer',eye:ptEye,correction:ptCorr})}

// ═══ Test ═══
function send(v,e){if(!isConn)return;tx({type:'input',value:v});if(navigator.vibrate)navigator.vibrate([8,30,4]);var btn=e&&e.currentTarget;if(btn){btn.classList.add('flash');setTimeout(function(){btn.classList.remove('flash')},180)}}
function updateRing(t,mx){
    var circ=2*Math.PI*21;
    document.getElementById('rfg').style.strokeDashoffset=circ*(1-t/mx);
    var num=document.getElementById('rnum');
    num.textContent=t;
    num.style.transform='scale(1.2)';
    setTimeout(function(){num.style.transform='scale(1)'},150);
}

// ═══ Results ═══
var resultData=null;
function showResults(d){
    resultData=d;
    setMode('m-res');
    var c=document.getElementById('result-content');
    c.innerHTML='';

    // Hero score
    c.innerHTML+='<div class="res-ey">Area Under Log CSF</div>';
    c.innerHTML+='<div class="res-sc">'+(d.score||'--')+'</div>';
    c.innerHTML+='<div class="res-rk">'+(d.rank||'')+'</div>';

    // Snellen + Peak
    c.innerHTML+='<div class="res-stats">'
        +'<div class="res-stat"><div class="rs-val">'+(d.snellen||'--')+'</div><div class="rs-lbl">Predicted Acuity</div></div>'
        +'<div class="res-stat"><div class="rs-val">'+(d.peakSens||'--')+'</div><div class="rs-lbl">Peak Sensitivity</div></div>'
        +'<div class="res-stat"><div class="rs-val">'+(d.peakFreq||'--')+' cpd</div><div class="rs-lbl">Peak Frequency</div></div>'
        +'</div>';

    // Plot placeholder (image arrives separately via plotImage message)
    c.innerHTML+='<img class="res-plot" style="display:none" alt="CSF Plot">';

    // Explorer CTA
    if(d.csfParams){
        var p=d.csfParams;
        var explorerUrl='https://calgaryvisioncentre.com/blog/seeing-beyond-2020?g='+p.g.toFixed(2)+'&f='+p.f.toFixed(1)+'&b='+p.b.toFixed(2)+'&d='+p.d.toFixed(2);
        c.innerHTML+='<div class="explorer-cta-card" style="opacity:0;animation:settleUp var(--settle) var(--ez) .65s forwards">'
            +'<div class="explorer-cta-label">Next: Explore What You Can See</div>'
            +'<div class="explorer-cta-desc">The interactive analyzer lets you see how your CSF curve applies to real-world objects \u2014 golf balls, road signs, pedestrians \u2014 at different distances and lighting. It\u2019s best viewed on a larger screen.</div>'
            +'<a class="explorer-cta-btn" href="'+explorerUrl+'" target="_blank" rel="noopener">Open on This Device \u2192</a>'
            +'<div class="explorer-cta-divider"></div>'
            +'<div class="explorer-cta-desc">Want to view it on a PC instead? Email yourself this link \u2014 it saves your data so you can pick up right where you left off.</div>'
            +'<button class="explorer-cta-btn email-self-btn" onclick="emailExplorerLink()" style="border-color:rgba(255,255,255,.25);background:rgba(255,255,255,.04);color:var(--t1)">Email Link to Myself</button>'
            +'</div>';
        window._explorerUrl=explorerUrl;
    }

    // Actions
    c.innerHTML+='<div class="res-actions">'
        +'<button class="res-btn primary" onclick="shareR()">Share Results</button>'
        +'<button class="res-btn" onclick="copyR()">Copy Text</button>'
        +'</div>'
        +'<div class="res-copied" id="rcp">Copied</div>';
}

function getRText(){
    if(!resultData)return'';
    var t='Burke Vision Lab Results\n';
    t+='========================\n';
    t+='AULCSF Score: '+resultData.score+'\n';
    t+='Rating: '+resultData.rank+'\n';
    t+='Predicted Acuity: '+(resultData.snellen||'--')+'\n';
    t+='Peak Sensitivity: '+(resultData.peakSens||'--')+' @ '+(resultData.peakFreq||'--')+' cpd\n';
    if(window._explorerUrl){
        t+='\nAnalyze your results:\n'+window._explorerUrl+'\n';
    }
    t+='\nDate: '+new Date().toLocaleDateString('en-US',{year:'numeric',month:'long',day:'numeric'});
    return t;
}
function shareR(){if(!resultData)return;if(navigator.share)navigator.share({title:'Burke Vision Lab Results',text:getRText()}).catch(function(){});else copyR()}
function copyR(){if(!resultData)return;navigator.clipboard.writeText(getRText()).then(function(){var e=document.getElementById('rcp');if(e){e.classList.add('show');setTimeout(function(){e.classList.remove('show')},2000)}}).catch(function(){})}
function copyExplorerUrl(){if(!window._explorerUrl)return;navigator.clipboard.writeText(window._explorerUrl).then(function(){var btns=document.querySelectorAll('.csf-formula-copy');btns.forEach(function(b){var orig=b.textContent;b.textContent='Copied!';b.style.borderColor='var(--a)';b.style.color='var(--a)';setTimeout(function(){b.textContent=orig;b.style.borderColor='';b.style.color=''},2000)})}).catch(function(){prompt('Copy this link:',window._explorerUrl)})}
function emailExplorerLink(){if(!window._explorerUrl)return;var subj=encodeURIComponent('Your Contrast Sensitivity Results \u2014 Burke Vision Lab');var body=encodeURIComponent('Here\u2019s your personalized link to explore your contrast sensitivity results:\n\n'+window._explorerUrl+'\n\nOpen this on a PC or tablet for the best experience. Your CSF curve and all your data are saved in the link.');window.location.href='mailto:?subject='+subj+'&body='+body}
</script></body></html>
