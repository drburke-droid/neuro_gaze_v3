<!DOCTYPE html><html lang="en"><head>
<meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Expires" content="0">
<title>Burke Vision Lab</title><link rel="stylesheet" href="main.css">
</head><body>

<!-- Screen: Welcome -->
<div id="scr-welcome" class="screen active">
<div class="moire-bg"><div class="moire-layer"></div><div class="moire-layer"></div><div class="moire-vignette"></div></div>
<div class="landing-stack">
<img class="landing-logo" src="cvc-logo.png" alt="CVC Logo">
<div class="landing-brand">Burke Vision Lab</div>
<div class="landing-title">Contrast Sensitivity<br>Function Test</div>
<div class="landing-desc">This test measures how well you see patterns at different sizes and contrasts &mdash; a more complete picture of your vision than an eye chart alone.<br><br>You'll need two devices: a large screen to display the targets and a phone or tablet as your controller.</div>
<button class="landing-begin" onclick="goToRole()">Begin Setup</button>
</div>
</div>

<!-- Screen: Role Selection -->
<div id="scr-role" class="screen">
<div class="landing-stack">
<div class="role-header">
<div class="role-illustration">
<div class="dev-icon dev-phone"><div class="dev-body"></div><div class="dev-label">Remote</div></div>
<div class="signal-dots"><span></span><span></span><span></span></div>
<div class="dev-icon dev-monitor"><div class="dev-body"></div><div class="dev-label">Display</div></div>
</div>
<div class="role-prompt">What is this device?</div>
</div>
<div class="role-cards">
<div class="role-card" onclick="selectRole('remote')">
<div class="role-card-title">Remote</div>
<div class="role-card-desc">This phone or tablet stays with you, 20 ft from the display</div>
</div>
<div class="role-card" id="card-display-role" onclick="selectRole('display')">
<div class="role-card-title">Display</div>
<div class="role-card-desc">This screen shows targets you'll view from 20 ft away</div>
<div class="role-card-disabled" id="display-disabled">Phone screens are too small for the test display</div>
</div>
</div>
<div class="role-hint">You'll set up and sync both devices to each other in the next steps.</div>
<button class="landing-back" onclick="goToWelcome()">Back</button>
</div>
</div>

<!-- Screen: Remote Pairing (phone generates code) -->
<div id="scr-pair-remote" class="screen">
<div class="landing-stack">
<div class="pair-section">
<div class="pair-label">Your pairing code</div>
<div class="pair-code" id="my-code">----</div>
<div class="pair-instruction">On your display, open <span class="pair-url" id="pair-url"></span> then tap <strong>Begin Setup</strong> &rarr; <strong>Display</strong> &rarr; enter this code</div>
<div class="pair-status" id="remote-status"><span class="sd sd-wait"></span> Waiting for display&hellip;</div>
</div>
<div class="pair-divider"><span>or</span></div>
<div class="pair-section pair-secondary">
<div class="pair-label-sm">Already have a code from your display?</div>
<div class="pair-input-row">
<input class="pair-input" id="remote-code-input" maxlength="4" placeholder="CODE" autocomplete="off" autocorrect="off" autocapitalize="characters" spellcheck="false">
<button class="pair-connect-btn" onclick="remoteEnterCode()">Connect</button>
</div>
</div>
<button class="landing-back" onclick="goToRole()">Back</button>
</div>
</div>

<!-- Screen: Display Pairing (PC enters phone's code or generates own) -->
<div id="scr-pair-display" class="screen">
<div class="landing-stack">
<div class="pair-section">
<div class="pair-label">Enter code from your phone</div>
<div class="pair-input-row">
<input class="pair-input pair-input-lg" id="display-code-input" maxlength="4" placeholder="CODE" autocomplete="off" autocorrect="off" autocapitalize="characters" spellcheck="false">
<button class="pair-connect-btn" onclick="displayEnterCode()">Connect</button>
</div>
<div class="pair-status" id="display-status"></div>
</div>
<div class="pair-divider"><span>or</span></div>
<div class="pair-section pair-secondary">
<div class="pair-label-sm">Don&rsquo;t have a code yet?</div>
<button class="pair-gen-btn" id="gen-code-btn" onclick="displayGenerateCode()">Generate Code</button>
<div id="display-code-area" style="display:none">
<div class="pair-label">Your display code</div>
<div class="pair-code" id="display-my-code">----</div>
<div class="pair-instruction">On your phone, go to <span class="pair-url" id="display-pair-url"></span>, tap <strong>Begin Setup</strong> &rarr; <strong>Phone</strong>, and enter this code. Or simply scan the QR code below.</div>
<div id="display-qrcode"></div>
<div class="pair-status" id="display-wait-status"><span class="sd sd-wait"></span> Waiting for phone&hellip;</div>
</div>
</div>
<button class="qr-skip" onclick="skipPhone()">Use Keyboard Instead</button>
<button class="landing-back" onclick="goToRole()">Back</button>
</div>
</div>

<div id="scr-cal" class="screen">
<div class="cal-box" id="cal-box">
<div class="dots"><div class="dot" id="d0"></div><div class="dot" id="d1"></div><div class="dot" id="d2"></div><div class="dot" id="d3"></div><div class="dot" id="d4"></div></div>

<!-- Step 0: Card (near) -->
<div id="cs0" class="cal-step active">
<div class="sn-n">Step 1 of 5</div><div class="h2-n">Physical Scale</div>
<p class="sd-n">Hold any card from your wallet — loyalty card, ID, or credit card — to the screen and match the rectangle to the card's width.</p>
<div id="card-sandbox"><div id="card-shape"></div></div>
<div id="card-local"><input type="range" id="ss" min="150" max="750" step="0.1" value="300">
<div class="sl"><span>Smaller</span><span class="v"><span id="sv">300</span> px</span><span>Larger</span></div></div>
<div id="card-remote" class="phone-hint-l" style="display:none;font-size:.65rem">Adjust on your phone</div>
<div class="cal-fn"><button class="bp-n" onclick="calGo(1)">Next</button></div>
</div>

<!-- Step 1: Mirror (near) -->
<div id="cs1" class="cal-step">
<div class="sn-n">Step 2 of 5</div><div class="h2-n">Setup Type</div>
<p class="sd-n">Will the patient view this screen through a mirror?</p>
<div class="mirror-wrap" style="flex:1;display:flex;align-items:center;justify-content:center">
<div class="mirror-choice">
<button class="mirror-btn" onclick="setMirror(false)">Direct View</button>
<button class="mirror-btn" onclick="setMirror(true)">Mirror View</button>
</div></div>
<div class="cal-fn"><button class="bb-n" onclick="calGo(0)">Back</button></div>
</div>

<!-- Step 2: Luminance (far) -->
<div id="cs2" class="cal-step">
<div class="sn-l">Step 3 of 5</div><div class="h2-l">Luminance</div>
<p class="sd-l">Adjust until the circle disappears into the pattern</p>
<div style="flex:1;display:flex;align-items:center;justify-content:center">
<div style="width:clamp(140px,20vw,200px);height:clamp(140px,20vw,200px);border-radius:50%;background-image:conic-gradient(#000 .25turn,#fff .25turn .5turn,#000 .5turn .75turn,#fff .75turn);background-size:2px 2px;display:flex;align-items:center;justify-content:center">
<div id="ic" style="width:clamp(60px,9vw,90px);height:clamp(60px,9vw,90px);border-radius:50%;background:rgb(128,128,128)"></div></div></div>
<div id="gamma-local"><input type="range" id="gs" min="60" max="220" value="128"><div class="sl"><span>Darker</span><span class="v" id="gv">128</span><span>Brighter</span></div></div>
<div id="gamma-remote" class="phone-hint-l" style="display:none">Adjust on your phone</div>
<div class="cal-fn"><button class="bb-l" onclick="calGo(1)">Back</button><button class="bp-l" onclick="calGo(3)">Next</button></div>
</div>

<!-- Step 3: Distance (far) -->
<div id="cs3" class="cal-step">
<div class="sn-l">Step 4 of 5</div><div class="h2-l">Viewing Distance</div>
<p class="sd-l">Enter distance from eyes to screen</p>
<div class="dist-wrap" style="flex:1;display:flex;flex-direction:column;justify-content:center;gap:14px;align-items:center">
<div style="display:flex;gap:14px;align-items:center">
<input type="number" class="dist-input" id="dv" placeholder="15" min="0.1" step="0.1">
<select class="dist-select" id="du"><option value="ft">feet</option><option value="m">meters</option><option value="cm">cm</option><option value="in">inches</option></select>
</div>
<div class="cal-em-l" id="de"></div>
<div class="dist-hint" style="font-family:var(--m);font-size:clamp(1rem,2.5vw,1.8rem);color:var(--t3);letter-spacing:1px;text-align:center;line-height:1.6;max-width:600px">Minimum 15 ft required. 20 ft+ preferred for clinical accuracy.</div>
</div>
<div class="cal-fn"><button class="bb-l" onclick="calGo(2)">Back</button><button class="bp-l" onclick="calValidate()">Review</button></div>
</div>

<!-- Step 4: Confirm (far) -->
<div id="cs4" class="cal-step">
<div class="sn-l">Step 5 of 5</div><div class="h2-l">Confirm</div>
<div style="flex:1;display:flex;align-items:center;justify-content:center">
<div class="cal-summary">
<div><span class="l">Mirror</span><span class="v" id="smi">Off</span></div>
<div><span class="l">Gamma</span><span class="v" id="sg">128</span></div>
<div><span class="l">Scale</span><span class="v" id="sp2">-</span></div>
<div><span class="l">Distance</span><span class="v" id="sdi">-</span></div>
<div style="margin-top:10px;padding-top:10px;border-top:1px solid var(--b)"><span class="l">Resolution</span><span class="v" id="spp">-</span></div>
<div id="ppd-warn" class="ppd-warn" style="display:none">PPD outside typical range (50–800) — double-check card scale and distance</div>
</div>
<div class="cal-phone-review phone-hint-l">Review setup on your phone</div>
</div>
<div class="cal-fn"><button class="bb-l" onclick="calGo(3)">Back</button><button class="bs-l" onclick="startTest()">Start Test</button></div>
</div>
<div class="cal-phone-hint">Follow instructions on your phone</div>
</div></div>

<div id="scr-test" class="screen">
<div class="display-frame" id="mirror-target">
<canvas id="stimCanvas" width="600" height="600"></canvas>
<div class="hud"><span class="hud-mode">Gabor 4-AFC</span><div class="progress-track"><div class="progress-fill" id="progress-fill"></div></div><span class="hud-progress" id="live-progress">0 / 50</span></div>
</div></div>

<!-- Tutorial is now a separate full-screen overlay, not inside display-frame -->
<div class="tut-overlay" id="tutorial" style="display:none">
<div class="tut-step-label" id="tut-step-label">Demo 1 of 5</div>
<div class="tut-orient-name" id="tut-orient-name">Vertical</div>
<div class="tut-plate-area">
<canvas class="tut-gabor" id="tut-canvas" width="400" height="400"></canvas>
<div class="tut-arrow-col">
<div class="tut-arrow-box" id="tut-arrow"></div>
<div class="tut-key-name" id="tut-key-name"></div>
</div>
</div>
<div class="tut-footer">
<div class="tut-dots" id="tut-dots"></div>
<div class="tut-hint" id="tut-hint"></div>
</div>
</div>

<!-- Pre-test questionnaire overlay -->
<div class="pretest-overlay" id="pretest" style="display:none">
<div class="pretest-label">Before we begin</div>
<div class="pretest-group">
<div class="pretest-q">Which eye(s) are being tested?</div>
<div class="pretest-opts" id="pt-eye">
<button class="pretest-btn" onclick="pickEye(this,'right')">Right</button>
<button class="pretest-btn" onclick="pickEye(this,'left')">Left</button>
<button class="pretest-btn" onclick="pickEye(this,'both')">Both</button>
</div>
</div>
<div class="pretest-group">
<div class="pretest-q">Corrective lenses?</div>
<div class="pretest-opts" id="pt-corr">
<button class="pretest-btn" onclick="pickCorr(this,'glasses')">Glasses</button>
<button class="pretest-btn" onclick="pickCorr(this,'contacts')">Contacts</button>
<button class="pretest-btn" onclick="pickCorr(this,'none')">None</button>
</div>
</div>
<button class="pretest-go" id="pt-go" disabled onclick="submitPreTest()">Continue</button>
</div>

<div id="scr-results" class="screen">
<div id="result-content">
<div class="result-eyebrow">Area Under Log CSF</div>
<div class="auc-value" id="final-auc">0.00</div>
<div class="rank-label" id="final-rank">--</div>
<div class="result-detail" id="final-detail"></div>
<canvas id="csf-plot"></canvas>
<div style="display:flex;gap:14px;margin-top:16px;opacity:0;animation:settleUp .5s var(--ez) .95s forwards">
<button class="restart-btn" onclick="location.reload()">Test Again</button>
<button class="restart-btn" id="share-plot-btn" onclick="sharePlot()" style="border-color:var(--a);color:var(--a)">Save / Share Chart</button>
</div>
</div></div>

<div id="gear-btn" onclick="showScreen('scr-cal');calGo(0)">&#9881;</div>
<script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js?v=2"></script>
<script>if(typeof Peer==='undefined'){var s=document.createElement('script');s.src='https://cdnjs.cloudflare.com/ajax/libs/peerjs/1.5.2/peerjs.min.js?v=2';document.head.appendChild(s)}</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js" onerror=""></script>
<script type="module" src="app.js"></script>
</body></html>
